<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>منصة حصيف — نموذج تشغيل تفاعلي (PRO v6)</title>
<style>
:root{--accent:#0b5b34;--gold:#c9a227;--bg:#f7f6f1;--ink:#111827;--muted:#6b7280;--bd:#e5e7eb;--card:#ffffff}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.6 system-ui,Segoe UI,Roboto,"Noto Naskh Arabic UI",Arial}
.wrap{max-width:1360px;margin:0 auto;padding:14px 18px}
.brand{display:flex;gap:14px;align-items:center;flex-wrap:wrap}
.brand .logos{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.brand img{height:46px;object-fit:contain;border-radius:8px}
.tools{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
select,input,button,textarea{font:inherit;padding:8px 10px;border:1px solid var(--bd);border-radius:10px}
button{background:var(--accent);color:#fff;border:none;cursor:pointer}
.btn-ghost{background:#fff;color:var(--accent);border:1px solid var(--accent)}
.layout{display:grid;grid-template-columns:300px 1fr;gap:14px}
aside{border:1px solid var(--bd);border-radius:14px;padding:12px;position:sticky;top:10px;height:max-content;background:var(--card)}
main{display:grid;gap:14px}
.card{border-radius:14px;padding:14px;border:1px solid var(--bd);background:var(--card)}
nav a{display:block;color:var(--ink);text-decoration:none;padding:8px 10px;border-radius:10px}
nav a:hover,nav a.active{background:#ecfdf5}
table{width:100%;border-collapse:collapse}
th,td{border-top:1px solid var(--bd);padding:8px;text-align:start;vertical-align:top;white-space:nowrap}
.grid{display:grid;gap:12px}
.grid-2{grid-template-columns:repeat(2,1fr)}
.grid-3{grid-template-columns:repeat(3,1fr)}
.grid-4{grid-template-columns:repeat(4,1fr)}
.grid-5{grid-template-columns:repeat(5,1fr)}
.kpi{display:flex;gap:10px;align-items:center}
.kpi .v{font-weight:800;font-size:22px;margin-top:2px}
.muted{color:var(--muted)}
.hr{height:1px;background:var(--bd);margin:10px 0}
.warn{background:rgba(250,204,21,.08);border:1px solid var(--gold);border-radius:10px;padding:8px}
footer{color:var(--muted);text-align:center;padding:18px}
.splash{position:fixed;inset:0;background:linear-gradient(180deg,#f8fafc 0%, #f7f6f1 100%);z-index:9999;display:flex;align-items:center;justify-content:center}
.splash .box{background:var(--card);border:1px solid var(--bd);border-radius:20px;max-width:980px;width:95%;padding:24px}
.splash .head{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:12px}
.splash .head .logos img{height:54px}
.splash h1{margin:0 0 6px;font-size:28px}
.splash p{margin:0;color:var(--muted)}
.splash .cta{display:flex;gap:10px;margin-top:16px;flex-wrap:wrap}
.tokenBox{white-space:nowrap;overflow:auto;max-width:420px}
.badge{display:inline-block;padding:.15rem .5rem;border-radius:999px;background:#ecfdf5;border:1px solid #a7f3d0;color:#065f46;font-weight:600}
.toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
.tabbar{display:flex;gap:8px;flex-wrap:wrap}
.tabbar button{background:#fff;color:var(--accent);border:1px solid var(--accent)}
.active-tab{background:var(--accent)!important;color:#fff!important}
.note{font-size:12px;color:var(--muted)}
@media (max-width:1100px){ .layout{grid-template-columns:1fr} aside{position:static} th,td{white-space:normal} }
</style>
</head>
<body>
<!-- شاشة ترحيب -->
<div class="splash" id="splash">
  <div class="box">
    <div class="head">
      <div class="logos">
        <img alt="Vision 2030" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQIW2P4z8DwHwAFGgJ7gk3G8QAAAABJRU5ErkJggg==">
      </div>
      <div class="logos">
        <img alt="Talbiya"  src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQIW2P4z8DwHwAFGgJ7gk3G8QAAAABJRU5ErkJggg==">
        <img alt="HASSEEF" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQIW2P4z8DwHwAFGgJ7gk3G8QAAAABJRU5ErkJggg==">
      </div>
    </div>
    <h1>منصة حصيف — نموذج تشغيل تفاعلي (PRO v6)</h1>
    <p>نسخة عرض تفاعلية تغطي كل الحسابات مع مسارات موافقات متعددة وربط مستهدفات رؤية 2030 — البيانات محلية.</p>
    <div class="cta">
      <button onclick="enterApp()" style="font-size:16px;padding:10px 16px;border-radius:10px">دخول المنصة</button>
    </div>
  </div>
</div>

<!-- رأس الصفحة -->
<header>
  <div class="wrap" style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
    <div class="brand">
      <div class="logos"><img alt="Vision 2030" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQIW2P4z8DwHwAFGgJ7gk3G8QAAAABJRU5ErkJggg=="></div>
      <div>
        <div style="font-weight:800">منصة حصيف — بوابة وطنية للتكامل التنموي</div>
        <div class="muted">رؤية 2030 • مبادرة تلبية • برنامج حصيف</div>
      </div>
    </div>
    <div class="tools">
      <form id="loginForm" class="grid" style="grid-template-columns:160px 220px 200px auto;gap:6px">
        <input name="username" placeholder="اسم المستخدم">
        <select name="role" id="roleSel">
          <option value="government">القطاع الحكومي</option>
          <option value="development_authority">هيئة التطوير</option>
          <option value="region">إمارة المنطقة</option>
          <option value="private">القطاع الخاص</option>
          <option value="nonprofit">القطاع غير الربحي</option>
          <option value="university">الجامعات</option>
          <option value="donor">الجهات المانحة/التمويلية</option>
          <option value="individual">الأفراد</option>
          <option value="admin">إدارة المنصة</option>
        </select>
        <select name="region" id="regionSel">
          <option value="الرياض">الرياض</option><option value="مكة">مكة</option><option value="الشرقية">الشرقية</option>
          <option value="المدينة">المدينة</option><option value="حائل">حائل</option><option value="نجران">نجران</option>
        </select>
        <button>تسجيل دخول</button>
        <button type="button" id="logoutBtn" class="btn-ghost">خروج</button>
      </form>
      <div class="tokenBox muted" id="tokenView">—</div>
    </div>
  </div>
</header>

<!-- تخطيط الصفحة -->
<div class="wrap layout">
  <aside>
    <h3 style="margin:0 0 8px">القوائم</h3>
    <small id="roleLabel" class="muted">—</small>
    <nav id="sideNav" style="margin-top:10px"></nav>
    <div class="hr"></div>
    <div class="toolbar">
      <input id="globalSearch" placeholder="بحث عام (عنوان/جهة/مدينة/هدف)">
      <button class="btn-ghost" onclick="exportJSON()">تصدير JSON</button>
      <button class="btn-ghost" onclick="importJSON()">استيراد JSON</button>
      <a id="downloadLink" style="display:none" download="hasif_export.json"></a>
    </div>
    <div class="warn"><strong>تنبيه:</strong> هذا نموذج متصفح فقط (لا يوجد خادم). البيانات محلية.</div>
  </aside>

  <main id="main"></main>
</div>

<footer>© HASIF Demo — Vision 2030 • Talbiya • HASSEEF</footer>

<script>
/* ======== أدوات عامة وتخزين محلي ======== */
const LS='hasif:data:pro_v6';
function ts(){return new Date().toISOString()}
function Q(s){return document.querySelector(s)}; function QA(s){return [...document.querySelectorAll(s)]}
function id(p){return p+'-'+Math.random().toString(36).slice(2,8)}
function datePlus(d){const x=new Date(); x.setDate(x.getDate()+d); return x.toISOString().slice(0,10)}
function db(){const raw=localStorage.getItem(LS); if(!raw){localStorage.setItem(LS, JSON.stringify(seed)); return JSON.parse(JSON.stringify(seed));} try{return JSON.parse(raw);}catch(e){localStorage.setItem(LS, JSON.stringify(seed)); return JSON.parse(JSON.stringify(seed));}}
function save(d){localStorage.setItem(LS, JSON.stringify(d))}
function tokenGen(role,user,region){const payload=btoa(JSON.stringify({role,user,region,iat:Date.now()})); return 'HASIF.'+payload;}
function audit(entity,action,details){const d=db(); d.audit.push({id:id('au'),ts:ts(),entity,action,details}); save(d)}

/* ======== بيانات أولية (قابلة للتوسعة) ======== */
const seed = {
  organizations:[
    {id:'org-gov-001',name:'وزارة التنمية',type:'gov',region:'الرياض'},
    {id:'org-priv-001',name:'شركة ألف',type:'private',region:'الرياض'},
    {id:'org-np-001',name:'جمعية بناء',type:'nonprofit',region:'الشرقية'},
    {id:'org-uni-001',name:'جامعة الملك المستقبل',type:'university',region:'مكة'},
    {id:'org-donor-001',name:'صندوق الأثر الوطني',type:'donor',region:'الرياض'},
    {id:'org-region-001',name:'إمارة الرياض',type:'region',region:'الرياض'},
    {id:'org-dev-001',name:'هيئة تطوير الرياض',type:'dev_auth',region:'الرياض'}
  ],
  // ربط مستهدفات رؤية 2030 على 3 مستويات
  visionGoals:[
    {id:'v-1',level:'استراتيجي',title:'اقتصاد مزدهر'},
    {id:'v-2',level:'برنامجي',title:'تنمية المهارات'},
    {id:'v-3',level:'هدف تفصيلي',title:'رفع التوظيف'}
  ],
  initiatives:[
    {id:'in-001',govOrgId:'org-gov-001',title:'مبادرة تمكين الخريجين',desc:'برنامج تأهيل رقمي شامل',vision:['v-1','v-2','v-3'],packages:[{name:'ذهبية',value:200000},{name:'فضية',value:100000}],status:'مطروحة',createdAt:ts()}
  ],
  facilities:[
    {id:'fa-001',ownerOrgId:'org-gov-001',name:'مسرح المدينة',city:'الرياض',capacity:500,policy:'دعم الفعاليات الموافقة',pricing:'مجاني'},
    {id:'fa-002',ownerOrgId:'org-uni-001',name:'قاعة المؤتمرات',city:'مكة',capacity:300,policy:'تأجير',pricing:'3000 SAR/يوم'}
  ],
  problems:[{id:'pb-001',ownerOrgId:'org-gov-001',title:'زيادة التطوع الصحي',domain:'صحة',status:'مفتوح'}],
  solutions:[
    {id:'sol-001',proposerOrgId:'org-uni-001',targetOrgId:'org-gov-001',summary:'مسار تدريب صحي معتمد',forProblem:'pb-001',type:'مستجابة',score:4.6},
    {id:'sol-002',proposerOrgId:'org-priv-001',targetOrgId:'org-gov-001',summary:'منصة متطوع صحي',forProblem:null,type:'اقتراح حر',score:4.2}
  ],
  coopTrain:[{id:'ct-001',ownerOrgId:'org-gov-001',title:'Coop IT 2026',seats:20,period:'2026-Q1',status:'معلن'}],
  jobs:[{id:'jb-001',ownerOrgId:'org-gov-001',title:'أخصائي بيانات',type:'بدوام كامل',status:'مفتوح'}],
  volunteering:[{id:'vo-001',ownerOrgId:'org-gov-001',title:'متطوع تحليلات بيانات',specialty:'تقني',hours:40,status:'مفتوح'}],
  events:[
    {id:'ev-001',ownerOrgId:'org-gov-001',title:'ملتقى الاقتصاد المزدهر',date:datePlus(35),city:'الرياض',speakers:['خبير1','خبير2'],
     approvals:{need:true, emirate:'قيد المراجعة', municipality:'قيد المراجعة', civildefense:'قيد المراجعة'}, packages:[{name:'ذهبية',value:150000}]}
  ],
  speakers:[{id:'spk-001',name:'أ. رندا',type:'متحدث',domain:'اقتصاد',rating:4.8},{id:'spk-002',name:'م. راكان',type:'مدرب',domain:'تقنية',rating:4.5}],
  csr:[{id:'csr-001',orgId:'org-priv-001',program:'تمكين خريجي التقنية',budget:150000,kpiTarget:500,period:'2025',status:'نشط'}],
  incubators:[{id:'ib-001',name:'مسرعة حصيف',ownerOrgId:'org-dev-001',acceptsFunding:true}],
  incubatorApps:[],
  endowments:[{id:'wa-001',ownerOrgId:'org-np-001',name:'وقف التعليم',mode:'استثمار/تأجير',status:'نشط'}],
  grants:[{id:'gr-001',donorOrgId:'org-donor-001',title:'منح الأثر 2026',focus:'تعليم/مهارات',min:50000,max:300000}],
  collab:[{id:'co-001',fromOrg:'org-gov-001',toOrg:'org-priv-001',related:'in-001',type:'شراكة رعاية',message:'نرغب بالتنسيق حول الرعاية الذهبية',status:'جديد',thread:[]}],
  mediaPR:[{id:'pr-001',owner:'org-gov-001',title:'بيان إعلامي: انطلاق مبادرة تمكين',status:'منشور',channels:['المنصة','X','LinkedIn']}],
  consultations:[{id:'cn-001',requester:'org-np-001',provider:'org-uni-001',topic:'قياس أثر مبادرة تعليمية',status:'قيد التعاقد'}],
  donorWallet:[{id:'dw-001',donorOrgId:'org-donor-001',balance:1000000,locked:0}],
  approvalsLog:[], reports:[], audit:[],
  // إضافات الجامعة
  uniPrograms:[{id:'up-001',uniId:'org-uni-001',title:'برنامج ريادة الأعمال',type:'أكاديمي',status:'نشط'}],
  uniResearch:[{id:'ur-001',uniId:'org-uni-001',title:'بحث قياس الأثر الاجتماعي',status:'منشور',link:'#'}],
  auth:{user:null,role:null,region:'الرياض',token:null}
};

/* ======== القوائم حسب الدور ======== */
const menus = {
  government:["لوحة المؤشرات","المبادرات للرعاية","المرافق","الإشكاليات/التحديات","الحلول (الواردة/الحرة)","الفعاليات & الموافقات","المتحدثون/المدربون","التدريب التعاوني","الوظائف","التطوع التخصصي","التواصل والشراكات","الاستشارات العلمية","الإعلام والعلاقات العامة","التقارير"],
  development_authority:["لوحة هيئة التطوير","الحاضنات/المسرعات","طلبات الاحتضان","المشاريع الإستراتيجية","ربط المناطق","التقارير"],
  region:["لوحة المنطقة","طلبات الموافقة (إمارة/بلدية/دفاع مدني)","سجل الموافقات","التقارير"],
  private:["لوحة CSR","رعاية المبادرات/الفعاليات","المرافق للتأجير","الفرص الاستثمارية","الوظائف","التدريب التعاوني","الفعاليات","الحلول المقترحة","الحاضنات","التقارير"],
  nonprofit:["لوحة المبادرات","الأوقاف/المرافق","الوظائف/التدريب/التطوع","التمويل/الرعايات","الاستشارات العلمية","الحلول","الإعلام","التقارير"],
  university:["لوحة الجامعة","برامج الجامعة","الأبحاث","التدريب التعاوني","المرافق","الشريك العلمي","استشارات أعضاء هيئة التدريس","الفعاليات","التقارير"],
  donor:["لوحة المانح","محفظة الجهة المانحة","معايير المنح","مطابقة المبادرات للمنح","طلبات التمويل/الرعاية","الأثر والتقارير"],
  individual:["ملفي","متحدث/مدرب/مستشار","الوظائف/التطوع/التدريب","الاستثمار/الرعاية","حضور الفعاليات","طرح حلول","طلب احتضان"],
  admin:["لوحة النظام","الحسابات والصلاحيات","الإشعارات","التدقيق","التقارير المجمعة","Swagger"]
};

/* ======== بناء الشريط الجانبي ======== */
function buildSide(){
  const role = Q('#roleSel').value;
  Q('#roleLabel').textContent = 'الحساب: '+role;
  const side = Q('#sideNav'); side.innerHTML='';
  const add=(txt,id)=>{const a=document.createElement('a');a.textContent=txt;a.href='#'+id;a.onclick=e=>{[...side.querySelectorAll('a')].forEach(x=>x.classList.remove('active'));e.target.classList.add('active')}; side.appendChild(a)};
  const list=menus[role]||[];
  add('لوحة المؤشرات','sec-dashboard');
  list.forEach(lbl=> add(lbl,'sec-'+lbl.replace(/\s+/g,'-')));
}

/* ======== واجهات المحتوى ======== */
function buildMain(){
  Q('#main').innerHTML = `
  <section class="card" id="sec-dashboard">
    <h2>لوحة المؤشرات — نظرة عامة</h2>
    <div class="grid grid-5">
      <div class="card"><strong>مبادرات للرعاية</strong><div id="kpi_in">—</div></div>
      <div class="card"><strong>مرافق متاحة</strong><div id="kpi_fa">—</div></div>
      <div class="card"><strong>حلول مقترحة</strong><div id="kpi_so">—</div></div>
      <div class="card"><strong>فعاليات تحتاج موافقات</strong><div id="kpi_ev">—</div></div>
      <div class="card"><strong>استشارات علمية</strong><div id="kpi_cn">—</div></div>
    </div>
    <div class="hr"></div>
    <div class="tabbar">
      <button class="active-tab" onclick="switchDash('all',this)">الكل</button>
      <button onclick="switchDash('government',this)">حكومي</button>
      <button onclick="switchDash('private',this)">خاص</button>
      <button onclick="switchDash('nonprofit',this)">غير ربحي</button>
      <button onclick="switchDash('university',this)">جامعات</button>
      <button onclick="switchDash('region',this)">إمارات</button>
      <button onclick="switchDash('donor',this)">مانح</button>
    </div>
    <div id="dashRows" class="grid grid-3" style="margin-top:10px"></div>
    <div class="note">تعقيب: هذه أرقام تشغيلية داخل النموذج، قابلة للمواءمة مع مؤشرات ملفاتك.</div>
  </section>

  <section class="card" id="sec-المبادرات-للرعاية">
    <h2>المبادرات/المشاريع المطروحة للرعاية (حكومي)</h2>
    <div class="toolbar"><span class="badge">ربط بمستهدفات الرؤية (3 مستويات)</span></div>
    <form id="inForm" class="grid grid-3">
      <input name="govOrgId" placeholder="Org ID حكومي" value="org-gov-001">
      <input name="title" placeholder="عنوان المبادرة">
      <input name="desc" placeholder="وصف مختصر">
      <input name="vision" placeholder="معرّفات الأهداف (،) مثل v-1،v-2،v-3">
      <input name="packages" placeholder="باقات (اسم:قيمة؛...) مثال: ذهبية:200000؛فضية:100000">
      <button>إضافة</button>
    </form>
    <table><thead><tr><th>#</th><th>الجهة</th><th>العنوان</th><th>أهداف الرؤية</th><th>الباقات</th><th>الحالة</th><th>طلب رعاية</th></tr></thead><tbody id="inT"></tbody></table>
  </section>

  <section class="card" id="sec-المرافق">
    <h2>المرافق المتاحة</h2>
    <form id="faForm" class="grid grid-3">
      <input name="ownerOrgId" placeholder="الجهة المالكة (Org ID)">
      <input name="name" placeholder="اسم المرفق"><input name="city" placeholder="المدينة">
      <input name="capacity" type="number" placeholder="السعة"><input name="policy" placeholder="السياسة">
      <input name="pricing" placeholder="التسعير"><button>إضافة</button>
    </form>
    <table><thead><tr><th>#</th><th>المالك</th><th>الاسم</th><th>المدينة</th><th>السعة</th><th>السياسة</th><th>التسعير</th></tr></thead><tbody id="faT"></tbody></table>
  </section>

  <section class="card" id="sec-الإشكاليات/التحديات">
    <h2>الإشكاليات/التحديات</h2>
    <form id="pbForm" class="grid grid-3">
      <input name="ownerOrgId" placeholder="Org ID"><input name="title" placeholder="عنوان الإشكالية">
      <input name="domain" placeholder="المجال"><button>إضافة</button>
    </form>
    <table><thead><tr><th>#</th><th>العنوان</th><th>المجال</th><th>الجهة</th><th>الحالة</th></tr></thead><tbody id="pbT"></tbody></table>
  </section>

  <section class="card" id="sec-الحلول-(الواردة/الحرة)">
    <h2>الحلول (المطلوبة/الاقتراحات الحرة)</h2>
    <form id="soForm" class="grid grid-3">
      <input name="proposerOrgId" placeholder="الجهة المقدِّمة (Org ID)"><input name="targetOrgId" placeholder="الجهة المستهدفة (Org ID)">
      <input name="summary" placeholder="ملخص الحل"><input name="forProblem" placeholder="معرّف الإشكالية (اختياري)">
      <select name="type"><option>مستجابة</option><option>اقتراح حر</option></select><button>إضافة</button>
    </form>
    <table><thead><tr><th>#</th><th>المُقترِح</th><th>المستهدف</th><th>النوع</th><th>للإشكالية</th><th>الملخص</th></tr></thead><tbody id="soT"></tbody></table>
  </section>

  <section class="card" id="sec-الفعاليات-&-الموافقات">
    <h2>الفعاليات & مسار الموافقات (إمارة/بلدية/دفاع مدني)</h2>
    <form id="evForm" class="grid grid-3">
      <input name="ownerOrgId" placeholder="Org ID"><input name="title" placeholder="عنوان الفعالية">
      <input name="date" placeholder="YYYY-MM-DD"><input name="city" placeholder="المدينة">
      <input name="speakers" placeholder="متحدثون (،)"><select name="needsApproval"><option value="true">تحتاج موافقات</option><option value="false">بدون موافقات</option></select>
      <button>إضافة</button>
    </form>
    <table><thead><tr><th>#</th><th>الجهة</th><th>العنوان</th><th>التاريخ</th><th>المدينة</th><th>المتحدثون</th><th>الإمارة</th><th>البلدية</th><th>الدفاع المدني</th><th>طلب رعاية</th></tr></thead><tbody id="evT"></tbody></table>
  </section>

  <section class="card" id="sec-طلبات-الموافقة-(إمارة/بلدية/دفاع-مدني)">
    <h2>لوحة الموافقات (لإمارة المنطقة والجهات المختصة)</h2>
    <p class="muted">إصدار قرارات موافقة/رفض بكل جهة مع سبب، وتسجيلها في سجل الموافقات.</p>
    <table><thead><tr><th>#</th><th>مرجع</th><th>العنوان</th><th>المدينة</th><th>الإمارة</th><th>البلدية</th><th>الدفاع المدني</th><th>قرارات</th></tr></thead><tbody id="apT"></tbody></table>
  </section>

  <section class="card" id="sec-سجل-الموافقات">
    <h2>سجل الموافقات (تتبع الأسباب)</h2>
    <table><thead><tr><th>#</th><th>الفعالية</th><th>الجهة</th><th>الحالة</th><th>السبب</th><th>التاريخ</th></tr></thead><tbody id="apLogT"></tbody></table>
  </section>

  <section class="card" id="sec-المتحدثون/المدربون">
    <h2>قاعدة المتحدثين والمدربين والمستشارين</h2>
    <form id="spkForm" class="grid grid-3">
      <input name="name" placeholder="الاسم">
      <select name="type"><option>متحدث</option><option>مدرب</option><option>مستشار</option><option>خبير/متقاعد</option></select>
      <input name="domain" placeholder="المجال"><button>إضافة</button>
    </form>
    <table><thead><tr><th>#</th><th>الاسم</th><th>النوع</th><th>المجال</th><th>التقييم</th></tr></thead><tbody id="spkT"></tbody></table>
  </section>

  <section class="card" id="sec-التدريب-التعاوني"><h2>التدريب التعاوني</h2>
    <form id="ctForm" class="grid grid-3"><input name="ownerOrgId" placeholder="Org ID"><input name="title" placeholder="العنوان">
      <input name="seats" type="number" placeholder="المقاعد"><input name="period" placeholder="الفترة"><button>إضافة</button></form>
    <table><thead><tr><th>#</th><th>المالك</th><th>العنوان</th><th>المقاعد</th><th>الفترة</th><th>الحالة</th></tr></thead><tbody id="ctT"></tbody></table>
  </section>

  <section class="card" id="sec-الوظائف"><h2>الوظائف</h2>
    <form id="jbForm" class="grid grid-3"><input name="ownerOrgId" placeholder="Org ID"><input name="title" placeholder="المسمى">
      <input name="type" placeholder="نوع الوظيفة"><button>إضافة</button></form>
    <table><thead><tr><th>#</th><th>الجهة</th><th>المسمى</th><th>النوع</th><th>الحالة</th></tr></thead><tbody id="jbT"></tbody></table>
  </section>

  <section class="card" id="sec-التطوع-التخصصي"><h2>التطوع التخصصي</h2>
    <form id="voForm" class="grid grid-3"><input name="ownerOrgId" placeholder="Org ID"><input name="title" placeholder="العنوان">
      <input name="specialty" placeholder="التخصص"><input name="hours" type="number" placeholder="الساعات"><button>إضافة</button></form>
    <table><thead><tr><th>#</th><th>الجهة</th><th>العنوان</th><th>التخصص</th><th>الساعات</th><th>الحالة</th></tr></thead><tbody id="voT"></tbody></table>
  </section>

  <section class="card" id="sec-التواصل-والشراكات">
    <h2>التواصل والتنسيق (Collab)</h2>
    <form id="coForm" class="grid grid-3">
      <input name="fromOrg" placeholder="من Org ID"><input name="toOrg" placeholder="إلى Org ID">
      <input name="related" placeholder="مرجع (in-*/ev-*/*)"><input name="type" placeholder="نوع الشراكة">
      <input name="message" placeholder="رسالة افتتاحية"><button>إرسال</button></form>
    <table><thead><tr><th>#</th><th>من</th><th>إلى</th><th>النوع</th><th>المرجع</th><th>الحالة</th><th>رد</th></tr></thead><tbody id="coT"></tbody></table>
  </section>

  <section class="card" id="sec-الاستشارات-العلمية">
    <h2>الاستشارات العلمية (جامعات ← جهات)</h2>
    <form id="cnForm" class="grid grid-3">
      <input name="requester" placeholder="الجهة الطالبة (Org ID)">
      <input name="provider" placeholder="الجهة العلمية (Org ID جامعة)">
      <input name="topic" placeholder="موضوع الاستشارة"><button>طلب/إضافة</button>
    </form>
    <table><thead><tr><th>#</th><th>الطالب</th><th>المزوِّد</th><th>الموضوع</th><th>الحالة</th></tr></thead><tbody id="cnT"></tbody></table>
  </section>

  <section class="card" id="sec-الإعلام-والعلاقات-العامة">
    <h2>الإعلام والعلاقات العامة</h2>
    <form id="prForm" class="grid grid-3">
      <input name="owner" placeholder="الجهة المالكة (Org ID)"><input name="title" placeholder="عنوان المادة">
      <select name="status"><option>مسودة</option><option>مجدول</option><option>منشور</option></select>
      <input name="channels" placeholder="قنوات النشر (،)"><button>إضافة</button>
    </form>
    <table><thead><tr><th>#</th><th>الجهة</th><th>العنوان</th><th>الحالة</th><th>القنوات</th></tr></thead><tbody id="prT"></tbody></table>
  </section>

  <section class="card" id="sec-لوحة-CSR">
    <h2>لوحة CSR (القطاع الخاص)</h2>
    <form id="csrForm" class="grid grid-3">
      <input name="orgId" placeholder="Org ID" value="org-priv-001"><input name="program" placeholder="اسم البرنامج">
      <input name="budget" type="number" placeholder="الميزانية"><input name="kpiTarget" type="number" placeholder="KPI مستهدف">
      <input name="period" placeholder="الفترة (YYYY)"><button>إضافة</button>
    </form>
    <table><thead><tr><th>#</th><th>الجهة</th><th>البرنامج</th><th>الميزانية</th><th>KPI</th><th>الفترة</th><th>الحالة</th></tr></thead><tbody id="csrT"></tbody></table>
  </section>

  <section class="card" id="sec-الأوقاف/المرافق">
    <h2>الأوقاف/المرافق (غير ربحي)</h2>
    <form id="waForm" class="grid grid-3"><input name="ownerOrgId" placeholder="Org ID">
      <input name="name" placeholder="اسم الوقف/المرفق"><select name="mode"><option>استثمار</option><option>تأجير</option></select><button>إضافة</button>
    </form>
    <table><thead><tr><th>#</th><th>المالك</th><th>الاسم</th><th>النمط</th><th>الحالة</th></tr></thead><tbody id="waT"></tbody></table>
  </section>

  <section class="card" id="sec-محفظة-الجهة-المانحة">
    <h2>محفظة الجهة المانحة</h2>
    <form id="dwForm" class="grid grid-3">
      <input name="donorOrgId" placeholder="Org ID مانح" value="org-donor-001">
      <input name="delta" type="number" placeholder="إيداع (+) / سحب (-)">
      <button>تحديث الرصيد</button>
    </form>
    <table><thead><tr><th>#</th><th>المانح</th><th>الرصيد</th><th>المحجوز</th></tr></thead><tbody id="dwT"></tbody></table>
  </section>

  <section class="card" id="sec-معايير-المنح">
    <h2>معايير الجهات المانحة</h2>
    <form id="grForm" class="grid grid-3">
      <input name="donorOrgId" placeholder="Org ID مانح" value="org-donor-001"><input name="title" placeholder="عنوان البرنامج">
      <input name="focus" placeholder="التركيز"><input name="min" type="number" placeholder="حد أدنى"><input name="max" type="number" placeholder="حد أقصى"><button>حفظ</button>
    </form>
    <table><thead><tr><th>#</th><th>المانح</th><th>البرنامج</th><th>التركيز</th><th>الحدود</th></tr></thead><tbody id="grT"></tbody></table>
  </section>

  <section class="card" id="sec-مطابقة-المبادرات-للمنح">
    <h2>مطابقة المبادرات/الفعاليات مع معايير المنح</h2>
    <div class="toolbar"><button class="btn-ghost" onclick="runGrantMatching()">تشغيل المطابقة</button></div>
    <table><thead><tr><th>#</th><th>برنامج المنح</th><th>التركيز</th><th>المبادرة/الفعالية</th><th>سبب التطابق</th></tr></thead><tbody id="matchT"></tbody></table>
    <div class="note">المعيار التجريبي الحالي: تطابق كلمات مفتاحية بسيطة بين (focus) والعنوان/الوصف/أهداف الرؤية.</div>
  </section>

  <section class="card" id="sec-الحاضنات/المسرعات">
    <h2>الحاضنات/المسرعات</h2>
    <form id="ibForm" class="grid grid-3"><input name="name" placeholder="الاسم"><input name="ownerOrgId" placeholder="Org ID">
      <select name="acceptsFunding"><option value="true">تستقبل تمويل</option><option value="false">بدون تمويل</option></select><button>إضافة</button>
    </form>
    <table><thead><tr><th>#</th><th>الاسم</th><th>المالك</th><th>تمويل</th></tr></thead><tbody id="ibT"></tbody></table>
  </section>

  <section class="card" id="sec-طلبات-الاحتضان">
    <h2>طلبات الاحتضان (مشاريع أفراد/جهات → حاضنات)</h2>
    <form id="ibAppForm" class="grid grid-3">
      <input name="incubatorId" placeholder="معرّف الحاضنة (ib-*)"><input name="owner" placeholder="الطالب (Org/Individual)">
      <input name="title" placeholder="عنوان المشروع/الفكرة"><button>إرسال طلب</button>
    </form>
    <table><thead><tr><th>#</th><th>الحاضنة</th><th>الطالب</th><th>العنوان</th><th>الحالة</th></tr></thead><tbody id="ibAppT"></tbody></table>
  </section>

  <section class="card" id="sec-برامج-الجامعة">
    <h2>برامج الجامعة</h2>
    <form id="upForm" class="grid grid-3"><input name="uniId" placeholder="Org ID جامعة" value="org-uni-001">
      <input name="title" placeholder="اسم البرنامج"><input name="type" placeholder="نوعه (أكاديمي/تنفيذي)"><button>إضافة</button>
    </form>
    <table><thead><tr><th>#</th><th>الجامعة</th><th>البرنامج</th><th>النوع</th><th>الحالة</th></tr></thead><tbody id="upT"></tbody></table>
  </section>

  <section class="card" id="sec-الأبحاث">
    <h2>أبحاث الجامعة</h2>
    <form id="urForm" class="grid grid-3"><input name="uniId" placeholder="Org ID جامعة" value="org-uni-001">
      <input name="title" placeholder="عنوان البحث"><input name="link" placeholder="رابط (اختياري)"><button>إضافة</button>
    </form>
    <table><thead><tr><th>#</th><th>الجامعة</th><th>البحث</th><th>الحالة</th><th>رابط</th></tr></thead><tbody id="urT"></tbody></table>
  </section>

  <section class="card" id="sec-التقارير">
    <h2>التقارير والمؤشرات</h2>
    <div id="repView" class="grid grid-4"></div>
    <button class="btn-ghost" onclick="generateReports()">تحديث التقارير</button>
  </section>

  <section class="card" id="sec-Swagger">
    <h2>Swagger/OpenAPI (عرض JSON)</h2>
    <textarea id="swaggerJson" style="width:100%;min-height:140px" placeholder='ألصق JSON OpenAPI لعرض المسارات'></textarea>
    <div id="swaggerOut" style="margin-top:8px"></div>
  </section>
  `;
}

/* ======== تصيير + بحث عام ======== */
function mfilter(txt, ...vals){ if(!txt) return true; txt = txt.toLowerCase(); return vals.some(v => (''+(v??'')).toLowerCase().includes(txt)); }
function renderAll(){
  const d=db(); const q=(Q('#globalSearch')?.value||'').trim();
  const S=(s)=>Q(s);

  S('#kpi_in').textContent=d.initiatives.length;
  S('#kpi_fa').textContent=d.facilities.length;
  S('#kpi_so').textContent=d.solutions.length;
  S('#kpi_ev').textContent=d.events.filter(e=>e.approvals?.need).length;
  S('#kpi_cn').textContent=d.consultations.length;

  // بطاقات حسب الأدوار (تلميحات سريعة)
  const dash = Q('#dashRows'); if(dash){ dash.innerHTML='';
    const cards=[
      {seg:'government',t:'طرح مبادرة للرعاية',d:'تعريف الحزم وربط مستهدفات 2030',k:'in'},
      {seg:'private',t:'طلب رعاية',d:'تقديم طلب رعاية لمبادرة/فعالية',k:'co'},
      {seg:'nonprofit',t:'طلب استشارة علمية',d:'من جامعة/كلية مختصة',k:'cn'},
      {seg:'university',t:'إدارة التدريب التعاوني',d:'ربط الطلاب مع الجهات',k:'ct'},
      {seg:'region',t:'مراجعة الموافقات',d:'إمارة/بلدية/دفاع مدني',k:'ap'},
      {seg:'donor',t:'مطابقة منح',d:'اقتراح مبادرات مطابقة للمعايير',k:'match'}
    ];
    cards.forEach(c=>{ const el=document.createElement('div'); el.className='card'; el.innerHTML=`<strong>${c.t}</strong><div class="muted">${c.d}</div>`; dash.appendChild(el); });
  }

  // المبادرات
  const inT=Q('#inT'); if(inT){ inT.innerHTML='';
    d.initiatives.filter(x=>mfilter(q,x.title,x.govOrgId)).forEach((x,i)=>{
      const vis=(x.vision||[]).map(v=> d.visionGoals.find(g=>g.id===v)?.title || v).join(' | ');
      const pk=(x.packages||[]).map(p=>p.name+':'+p.value).join('،');
      inT.innerHTML+=`<tr><td>${i+1}</td><td>${x.govOrgId}</td><td>${x.title}</td><td>${vis}</td><td>${pk}</td><td>${x.status}</td>
        <td><button class='btn-ghost' onclick="requestSponsorship('${x.id}')">طلب رعاية</button></td></tr>`;
    });
  }
  // المرافق
  const faT=Q('#faT'); if(faT){ faT.innerHTML='';
    d.facilities.filter(x=>mfilter(q,x.name,x.city,x.ownerOrgId)).forEach((x,i)=>{
      faT.innerHTML+=`<tr><td>${i+1}</td><td>${x.ownerOrgId}</td><td>${x.name}</td><td>${x.city}</td><td>${x.capacity}</td><td>${x.policy}</td><td>${x.pricing}</td></tr>`;
    });
  }
  // الإشكاليات
  const pbT=Q('#pbT'); if(pbT){ pbT.innerHTML='';
    d.problems.filter(x=>mfilter(q,x.title,x.domain,x.ownerOrgId)).forEach((x,i)=>{
      pbT.innerHTML+=`<tr><td>${i+1}</td><td>${x.title}</td><td>${x.domain}</td><td>${x.ownerOrgId}</td><td>${x.status}</td></tr>`;
    });
  }
  // الحلول
  const soT=Q('#soT'); if(soT){ soT.innerHTML='';
    d.solutions.filter(x=>mfilter(q,x.summary,x.proposerOrgId,x.targetOrgId)).forEach((x,i)=>{
      soT.innerHTML+=`<tr><td>${i+1}</td><td>${x.proposerOrgId}</td><td>${x.targetOrgId}</td><td>${x.type}</td><td>${x.forProblem||'-'}</td><td>${x.summary}</td></tr>`;
    });
  }
  // الفعاليات
  const evT=Q('#evT'); if(evT){ evT.innerHTML='';
    d.events.filter(x=>mfilter(q,x.title,x.city,x.ownerOrgId)).forEach((x,i)=>{
      const spk=(x.speakers||[]).join('،');
      const ap=x.approvals||{};
      evT.innerHTML+=`<tr><td>${i+1}</td><td>${x.ownerOrgId}</td><td>${x.title}</td><td>${x.date}</td><td>${x.city}</td><td>${spk}</td>
        <td>${ap.need?(ap.emirate||'قيد المراجعة'):'—'}</td><td>${ap.need?(ap.municipality||'قيد المراجعة'):'—'}</td><td>${ap.need?(ap.civildefense||'قيد المراجعة'):'—'}</td>
        <td><button class='btn-ghost' onclick="requestEventSponsorship('${x.id}')">طلب رعاية</button></td></tr>`;
    });
  }
  // الموافقات
  const apT=Q('#apT'); if(apT){ apT.innerHTML='';
    d.events.filter(e=>e.approvals?.need).forEach((x,i)=>{
      apT.innerHTML+=`<tr><td>${i+1}</td><td>${x.id}</td><td>${x.title}</td><td>${x.city}</td>
        <td>${x.approvals.emirate}</td><td>${x.approvals.municipality}</td><td>${x.approvals.civildefense}</td>
        <td>
          <button onclick="approveEvent('${x.id}','emirate',true)">إمارة ✓</button>
          <button class="btn-ghost" onclick="approveEvent('${x.id}','emirate',false)">إمارة ✗</button>
          <button onclick="approveEvent('${x.id}','municipality',true)">بلدية ✓</button>
          <button class="btn-ghost" onclick="approveEvent('${x.id}','municipality',false)">بلدية ✗</button>
          <button onclick="approveEvent('${x.id}','civildefense',true)">دفاع ✓</button>
          <button class="btn-ghost" onclick="approveEvent('${x.id}','civildefense',false)">دفاع ✗</button>
        </td></tr>`;
    });
  }
  // سجل الموافقات
  const apLogT=Q('#apLogT'); if(apLogT){ apLogT.innerHTML='';
    d.approvalsLog.forEach((r,i)=>{
      apLogT.innerHTML+=`<tr><td>${i+1}</td><td>${r.ref}</td><td>${r.gate}</td><td>${r.ok?'موافق':'مرفوض'}</td><td>${r.reason||'-'}</td><td>${r.ts}</td></tr>`;
    });
  }
  // المتحدثون
  const spkT=Q('#spkT'); if(spkT){ spkT.innerHTML='';
    d.speakers.filter(x=>mfilter(q,x.name,x.type,x.domain)).forEach((x,i)=>{
      spkT.innerHTML+=`<tr><td>${i+1}</td><td>${x.name}</td><td>${x.type}</td><td>${x.domain}</td><td>${x.rating||'-'}</td></tr>`;
    });
  }
  // تدريب/وظائف/تطوع
  const ctT=Q('#ctT'); if(ctT){ ctT.innerHTML=''; d.coopTrain.filter(x=>mfilter(q,x.title,x.ownerOrgId)).forEach((x,i)=>{
    ctT.innerHTML+=`<tr><td>${i+1}</td><td>${x.ownerOrgId}</td><td>${x.title}</td><td>${x.seats}</td><td>${x.period}</td><td>${x.status||'-'}</td></tr>`;
  });}
  const jbT=Q('#jbT'); if(jbT){ jbT.innerHTML=''; d.jobs.filter(x=>mfilter(q,x.title,x.ownerOrgId,x.type)).forEach((x,i)=>{
    jbT.innerHTML+=`<tr><td>${i+1}</td><td>${x.ownerOrgId}</td><td>${x.title}</td><td>${x.type}</td><td>${x.status||'-'}</td></tr>`;
  });}
  const voT=Q('#voT'); if(voT){ voT.innerHTML=''; d.volunteering.filter(x=>mfilter(q,x.title,x.ownerOrgId,x.specialty)).forEach((x,i)=>{
    voT.innerHTML+=`<tr><td>${i+1}</td><td>${x.ownerOrgId}</td><td>${x.title}</td><td>${x.specialty}</td><td>${x.hours}</td><td>${x.status||'-'}</td></tr>`;
  });}
  // Collab
  const coT=Q('#coT'); if(coT){ coT.innerHTML='';
    d.collab.filter(x=>mfilter(q,x.type,x.fromOrg,x.toOrg,x.related)).forEach((x,i)=>{
      coT.innerHTML+=`<tr><td>${i+1}</td><td>${x.fromOrg}</td><td>${x.toOrg}</td><td>${x.type}</td><td>${x.related||'-'}</td><td>${x.status}</td>
        <td><button class='btn-ghost' onclick="replyCollab('${x.id}')">رد</button></td></tr>`;
    });
  }
  // استشارات علمية
  const cnT=Q('#cnT'); if(cnT){ cnT.innerHTML='';
    d.consultations.filter(x=>mfilter(q,x.topic,x.requester,x.provider)).forEach((x,i)=>{
      cnT.innerHTML+=`<tr><td>${i+1}</td><td>${x.requester}</td><td>${x.provider}</td><td>${x.topic}</td><td>${x.status}</td></tr>`;
    });
  }
  // إعلام
  const prT=Q('#prT'); if(prT){ prT.innerHTML='';
    d.mediaPR.filter(x=>mfilter(q,x.title,x.owner,(x.channels||[]).join(','))).forEach((x,i)=>{
      prT.innerHTML+=`<tr><td>${i+1}</td><td>${x.owner}</td><td>${x.title}</td><td>${x.status}</td><td>${(x.channels||[]).join('،')}</td></tr>`;
    });
  }
  // CSR / أوقاف / محفظة / منح / حاضنات / طلبات احتضان
  const csrT=Q('#csrT'); if(csrT){ csrT.innerHTML='';
    d.csr.filter(x=>mfilter(q,x.program,x.orgId)).forEach((x,i)=>{ csrT.innerHTML+=`<tr><td>${i+1}</td><td>${x.orgId}</td><td>${x.program}</td><td>${x.budget}</td><td>${x.kpiTarget}</td><td>${x.period}</td><td>${x.status}</td></tr>`;});
  }
  const waT=Q('#waT'); if(waT){ waT.innerHTML='';
    d.endowments.filter(x=>mfilter(q,x.name,x.ownerOrgId,x.mode)).forEach((x,i)=>{ waT.innerHTML+=`<tr><td>${i+1}</td><td>${x.ownerOrgId}</td><td>${x.name}</td><td>${x.mode}</td><td>${x.status||'-'}</td></tr>`;});
  }
  const dwT=Q('#dwT'); if(dwT){ dwT.innerHTML='';
    d.donorWallet.forEach((x,i)=>{ dwT.innerHTML+=`<tr><td>${i+1}</td><td>${x.donorOrgId}</td><td>${x.balance}</td><td>${x.locked}</td></tr>`;});
  }
  const grT=Q('#grT'); if(grT){ grT.innerHTML='';
    d.grants.filter(x=>mfilter(q,x.title,x.focus,x.donorOrgId)).forEach((x,i)=>{ grT.innerHTML+=`<tr><td>${i+1}</td><td>${x.donorOrgId}</td><td>${x.title}</td><td>${x.focus}</td><td>${x.min}–${x.max}</td></tr>`;});
  }
  const ibT=Q('#ibT'); if(ibT){ ibT.innerHTML='';
    d.incubators.filter(x=>mfilter(q,x.name,x.ownerOrgId)).forEach((x,i)=>{ ibT.innerHTML+=`<tr><td>${i+1}</td><td>${x.name}</td><td>${x.ownerOrgId}</td><td>${x.acceptsFunding?'نعم':'لا'}</td></tr>`;});
  }
  const ibAppT=Q('#ibAppT'); if(ibAppT){ ibAppT.innerHTML='';
    d.incubatorApps.forEach((x,i)=>{ ibAppT.innerHTML+=`<tr><td>${i+1}</td><td>${x.incubatorId}</td><td>${x.owner}</td><td>${x.title}</td><td>${x.status||'قيد المراجعة'}</td></tr>`;});
  }

  renderSwagger();
}

/* ======== تبديل تبويب المؤشرات (عرض تعبيري) ======== */
function switchDash(seg,btn){ QA('.tabbar button').forEach(b=>b.classList.remove('active-tab')); btn.classList.add('active-tab'); }

/* ======== معالجة النماذج ======== */
function parsePackages(s){ if(!s) return []; return s.split('؛').map(x=>x.trim()).filter(Boolean).map(pair=>{const [n,v]=pair.split(':'); return {name:(n||'').trim(), value:+(v||0)};}); }

function wire(){
  // دخول/خروج
  Q('#loginForm').addEventListener('submit', e=>{
    e.preventDefault(); const f=Object.fromEntries(new FormData(e.target));
    const d=db(); d.auth.user=f.username||'demo'; d.auth.role=f.role; d.auth.region=f.region||'الرياض'; d.auth.token=tokenGen(f.role,d.auth.user,d.auth.region);
    save(d); audit('auth','login',d.auth); Q('#tokenView').textContent=d.auth.token; buildSide();
  });
  Q('#logoutBtn').addEventListener('click', ()=>{const d=db(); d.auth={user:null,role:null,region:'',token:null}; save(d); audit('auth','logout',{}); Q('#tokenView').textContent='—';});

  const d=db();

  // حكومي
  Q('#inForm')?.addEventListener('submit', e=>{e.preventDefault(); const f=Object.fromEntries(new FormData(e.target));
    const goals=(f.vision||'').split('،').map(x=>x.trim()).filter(Boolean);
    const rec={id:id('in'),govOrgId:f.govOrgId,title:f.title,desc:f.desc,vision:goals,packages:parsePackages(f.packages),status:'مطروحة',createdAt:ts()};
    d.initiatives.push(rec); save(d); audit('initiative','create',rec); renderAll(); e.target.reset();});
  Q('#faForm')?.addEventListener('submit', e=>{e.preventDefault(); const f=Object.fromEntries(new FormData(e.target));
    const rec={id:id('fa'),...f,capacity:+f.capacity||0}; d.facilities.push(rec); save(d); audit('facility','create',rec); renderAll(); e.target.reset();});
  Q('#pbForm')?.addEventListener('submit', e=>{e.preventDefault(); const f=Object.fromEntries(new FormData(e.target));
    const rec={id:id('pb'),...f,status:'مفتوح'}; d.problems.push(rec); save(d); audit('problem','create',rec); renderAll(); e.target.reset();});
  Q('#soForm')?.addEventListener('submit', e=>{e.preventDefault(); const f=Object.fromEntries(new FormData(e.target));
    const rec={id:id('so'),...f,score:0}; d.solutions.push(rec); save(d); audit('solution','create',rec); renderAll(); e.target.reset();});
  Q('#evForm')?.addEventListener('submit', e=>{e.preventDefault(); const f=Object.fromEntries(new FormData(e.target));
    const approvals = f.needsApproval==='true' ? {need:true,emirate:'قيد المراجعة',municipality:'قيد المراجعة',civildefense:'قيد المراجعة'} : {need:false};
    const rec={id:id('ev'),ownerOrgId:f.ownerOrgId,title:f.title,date:f.date||datePlus(10),city:f.city,speakers:(f.speakers||'').split('،').map(s=>s.trim()).filter(Boolean),approvals,packages:[]};
    d.events.push(rec); save(d); audit('event','create',rec); renderAll(); e.target.reset();});

  // المتحدثون
  Q('#spkForm')?.addEventListener('submit', e=>{e.preventDefault(); const f=Object.fromEntries(new FormData(e.target));
    const rec={id:id('spk'),...f,rating:0}; d.speakers.push(rec); save(d); audit('speaker','create',rec); renderAll(); e.target.reset();});

  // تدريب/وظائف/تطوع
  Q('#ctForm')?.addEventListener('submit', e=>{e.preventDefault(); const f=Object.fromEntries(new FormData(e.target));
    const rec={id:id('ct'),...f,seats:+f.seats||0,status:'معلن'}; d.coopTrain.push(rec); save(d); audit('coop','create',rec); renderAll(); e.target.reset();});
  Q('#jbForm')?.addEventListener('submit', e=>{e.preventDefault(); const f=Object.fromEntries(new FormData(e.target));
    const rec={id:id('jb'),...f,status:'مفتوح'}; d.jobs.push(rec); save(d); audit('job','create',rec); renderAll(); e.target.reset();});
  Q('#voForm')?.addEventListener('submit', e=>{e.preventDefault(); const f=Object.fromEntries(new FormData(e.target));
    const rec={id:id('vo'),...f,hours:+f.hours||0,status:'مفتوح'}; d.volunteering.push(rec); save(d); audit('volunteer','create',rec); renderAll(); e.target.reset();});

  // الشراكات
  Q('#coForm')?.addEventListener('submit', e=>{e.preventDefault(); const f=Object.fromEntries(new FormData(e.target));
    const rec={id:id('co'),...f,status:'جديد',thread:[]}; d.collab.push(rec); save(d); audit('collab','create',rec); renderAll(); e.target.reset();});

  // الاستشارات العلمية
  Q('#cnForm')?.addEventListener('submit', e=>{e.preventDefault(); const f=Object.fromEntries(new FormData(e.target));
    const rec={id:id('cn'),...f,status:'قيد التعاقد'}; d.consultations.push(rec); save(d); audit('consultation','create',rec); renderAll(); e.target.reset();});

  // الإعلام
  Q('#prForm')?.addEventListener('submit', e=>{e.preventDefault(); const f=Object.fromEntries(new FormData(e.target));
    const rec={id:id('pr'),owner:f.owner,title:f.title,status:f.status,channels:(f.channels||'').split('،').map(x=>x.trim()).filter(Boolean)}; d.mediaPR.push(rec); save(d); audit('media','create',rec); renderAll(); e.target.reset();});

  // CSR / أوقاف / محفظة / منح / حاضنات / طلبات احتضان
  Q('#csrForm')?.addEventListener('submit', e=>{e.preventDefault(); const f=Object.fromEntries(new FormData(e.target));
    const rec={id:id('csr'),orgId:f.orgId,program:f.program,budget:+f.budget||0,kpiTarget:+f.kpiTarget||0,period:f.period,status:'نشط'}; d.csr.push(rec); save(d); audit('csr','create',rec); renderAll(); e.target.reset();});
  Q('#waForm')?.addEventListener('submit', e=>{e.preventDefault(); const f=Object.fromEntries(new FormData(e.target));
    const rec={id:id('wa'),...f,status:'نشط'}; d.endowments.push(rec); save(d); audit('waqf','create',rec); renderAll(); e.target.reset();});
  Q('#grForm')?.addEventListener('submit', e=>{e.preventDefault(); const f=Object.fromEntries(new FormData(e.target));
    const rec={id:id('gr'),donorOrgId:f.donorOrgId,title:f.title,focus:f.focus,min:+f.min||0,max:+f.max||0}; d.grants.push(rec); save(d); audit('grant-criteria','create',rec); renderAll(); e.target.reset();});
  Q('#ibForm')?.addEventListener('submit', e=>{e.preventDefault(); const f=Object.fromEntries(new FormData(e.target));
    const rec={id:id('ib'),name:f.name,ownerOrgId:f.ownerOrgId,acceptsFunding:(f.acceptsFunding==='true')}; d.incubators.push(rec); save(d); audit('incubator','create',rec); renderAll(); e.target.reset();});
  Q('#ibAppForm')?.addEventListener('submit', e=>{e.preventDefault(); const f=Object.fromEntries(new FormData(e.target));
    const rec={id:id('iba'),incubatorId:f.incubatorId,owner:f.owner,title:f.title,status:'قيد المراجعة'}; d.incubatorApps.push(rec); save(d); audit('incubator-app','create',rec); renderAll(); e.target.reset();});
  Q('#dwForm')?.addEventListener('submit', e=>{e.preventDefault(); const f=Object.fromEntries(new FormData(e.target));
    const w=d.donorWallet.find(x=>x.donorOrgId===f.donorOrgId) || {id:id('dw'),donorOrgId:f.donorOrgId,balance:0,locked:0};
    if(!d.donorWallet.some(x=>x.donorOrgId===f.donorOrgId)) d.donorWallet.push(w);
    w.balance += (+f.delta||0); save(d); audit('donor-wallet','update',{donor:w.donorOrgId,delta:+f.delta||0}); renderAll(); e.target.reset();});

  // برامج/أبحاث الجامعة
  Q('#upForm')?.addEventListener('submit', e=>{e.preventDefault(); const f=Object.fromEntries(new FormData(e.target));
    const rec={id:id('up'),uniId:f.uniId,title:f.title,type:f.type||'أكاديمي',status:'نشط'}; d.uniPrograms.push(rec); save(d); audit('uni-program','create',rec); renderAll(); e.target.reset();});
  Q('#urForm')?.addEventListener('submit', e=>{e.preventDefault(); const f=Object.fromEntries(new FormData(e.target));
    const rec={id:id('ur'),uniId:f.uniId,title:f.title,status:'منشور',link:f.link||'#'}; d.uniResearch.push(rec); save(d); audit('uni-research','create',rec); renderAll(); e.target.reset();});

  // Swagger
  Q('#swaggerJson')?.addEventListener('input', renderSwagger);
}

/* ======== وظائف خاصة ======== */
function requestSponsorship(inId){
  const d=db();
  const initiative = d.initiatives.find(x=>x.id===inId); if(!initiative) return alert('المبادرة غير موجودة');
  const org = prompt('أدخل Org ID للجهة الراعية (مثال: org-priv-001):','org-priv-001'); if(!org) return;
  const pkg = prompt('اختر الباقة (اكتب الاسم كما في الجدول: ذهبية/فضية...):','ذهبية');
  const coll = {id:id('co'),fromOrg:org,toOrg:initiative.govOrgId,related:inId,type:'طلب رعاية',message:'طلب رعاية باقة '+pkg,status:'جديد',thread:[]};
  d.collab.push(coll); save(d); audit('sponsorship','request',coll); renderAll(); alert('تم إرسال طلب الرعاية.');
}
function requestEventSponsorship(evId){
  const d=db(); const ev=d.events.find(e=>e.id===evId); if(!ev) return alert('الفعالية غير موجودة');
  const org = prompt('أدخل Org ID للجهة الراعية:','org-priv-001'); if(!org) return;
  const coll = {id:id('co'),fromOrg:org,toOrg:ev.ownerOrgId,related:evId,type:'طلب رعاية فعالية',message:'نرغب برعاية هذه الفعالية',status:'جديد',thread:[]};
  d.collab.push(coll); save(d); audit('event-sponsorship','request',coll); renderAll(); alert('تم إرسال طلب الرعاية.');
}
function approveEvent(evId, gate, ok){
  const d=db(); const ev = d.events.find(x=>x.id===evId); if(!ev) return;
  const reason = ok? 'تمت الموافقة' : prompt('سبب الرفض؟','');
  if(!ev.approvals) ev.approvals={need:true,emirate:'قيد المراجعة',municipality:'قيد المراجعة',civildefense:'قيد المراجعة'};
  ev.approvals[gate] = ok? 'موافق' : ('مرفوض'+(reason?': '+reason:'')); 
  const rec = {id:id('ap'),ref:evId,gate,ok,reason:reason||'',ts:ts()};
  d.approvalsLog.push(rec); save(d); audit('multi-approval', ok?'approve':'reject', rec); renderAll();
}
function replyCollab(coId){
  const d=db(); const co=d.collab.find(x=>x.id===coId); if(!co) return;
  const msg = prompt('اكتب ردك:','تم الاطلاع وسننسق الموعد'); if(!msg) return;
  co.thread.push({by:(d.auth.user||'user'),ts:ts(),msg}); co.status='قيد التنسيق'; save(d); audit('collab','reply',{coId,msg}); renderAll();
}

/* ======== مطابقة المنح ======== */
function textBag(x){ return (x||'').toString().toLowerCase(); }
function goalTitles(ids){ const d=db(); return (ids||[]).map(v=> d.visionGoals.find(g=>g.id===v)?.title || '').join(' '); }
function runGrantMatching(){
  const d=db(); const out=Q('#matchT'); if(!out) return; out.innerHTML='';
  const items=[
    ...d.initiatives.map(it=>({kind:'مبادرة', title:it.title, desc:it.desc, goals:goalTitles(it.vision)})),
    ...d.events.map(ev=>({kind:'فعالية', title:ev.title, desc:'', goals:''}))
  ];
  let row=0;
  d.grants.forEach(gr=>{
    const focus=textBag(gr.focus);
    items.forEach(it=>{
      const bag=textBag(`${it.title} ${it.desc} ${it.goals}`);
      if(focus && bag.includes(focus.split('/')[0])){ // تطابق بسيط أولي
        out.innerHTML+=`<tr><td>${++row}</td><td>${gr.title}</td><td>${gr.focus}</td><td>${it.kind}: ${it.title}</td><td>تطابق كلمات مفتاحية (${gr.focus})</td></tr>`;
      }
    });
  });
  if(!row) out.innerHTML='<tr><td colspan="5">لا توجد تطابقات وفق القاعدة التجريبية الحالية.</td></tr>';
}

/* ======== تقارير ======== */
function generateReports(){
  const d=db();
  const byRegion = (list)=> list.reduce((m,x)=>{const r=(x.region)||(d.organizations.find(o=>o.id===x.ownerOrgId||o.id===x.govOrgId)?.region)||'غير محدد'; m[r]=(m[r]||0)+1; return m;},{});
  const rep = [
    {k:'مبادرات مطروحة', v:d.initiatives.length},
    {k:'حلول واردة', v:d.solutions.length},
    {k:'فعاليات تحتاج موافقات', v:d.events.filter(e=>e.approvals?.need).length},
    {k:'قرارات موافقات مسجلة', v:d.approvalsLog.length},
    {k:'فرص تدريب تعاوني', v:d.coopTrain.length},
    {k:'وظائف', v:d.jobs.length},
    {k:'تطوع تخصصي', v:d.volunteering.length},
    {k:'مرافق متاحة', v:d.facilities.length},
    {k:'قنوات تواصل نشطة', v:d.collab.length},
    {k:'برامج CSR نشطة', v:d.csr.length},
    {k:'استشارات علمية', v:d.consultations.length},
    {k:'مواد إعلامية', v:d.mediaPR.length},
    {k:'حاضنات/مسرعات', v:d.incubators.length},
    {k:'محافظ مانحين', v:d.donorWallet.length},
    {k:'برامج منح', v:d.grants.length},
  ];
  d.reports = rep; save(d); renderReports();
}
function renderReports(){
  const d=db(); const box = Q('#repView'); if(!box) return; box.innerHTML='';
  d.reports.forEach(r=>{ const c=document.createElement('div'); c.className='card'; c.innerHTML=`<div><strong>${r.k}</strong></div><div class='muted'>${r.v}</div>`; box.appendChild(c); });
}

/* ======== Swagger/OpenAPI Viewer ======== */
function renderSwagger(){
  const el=Q('#swaggerOut'); if(!el) return;
  const txt=Q('#swaggerJson').value?.trim()||'';
  if(!txt){ el.innerHTML='<div class="muted">ألصق JSON OpenAPI لعرض المسارات</div>'; return; }
  let spec; try{ spec=JSON.parse(txt); }catch(e){ el.innerHTML='<div class="warn">JSON غير صالح</div>'; return; }
  if(!spec.paths){ el.innerHTML='<div class="warn">لا يوجد paths</div>'; return; }
  el.innerHTML = Object.entries(spec.paths).map(([p,ops])=>`<div class='card' style='margin-bottom:6px'><strong>${p}</strong><div class='muted'>${Object.keys(ops).join(', ')}</div></div>`).join('');
}

/* ======== تصدير/استيراد JSON ======== */
function exportJSON(){ const data = JSON.stringify(db(), null, 2); const blob = new Blob([data], {type:'application/json'}); const url = URL.createObjectURL(blob); const a = Q('#downloadLink'); a.href = url; a.click(); }
function importJSON(){ const txt = prompt('ألصق JSON هنا:'); if(!txt) return; try{ const obj = JSON.parse(txt); save(obj); alert('تم الاستيراد.'); renderAll(); } catch(e){ alert('JSON غير صالح'); } }

/* ======== تشغيل ======== */
function buildSideAndMain(){ buildSide(); buildMain(); renderAll(); wire(); const d=db(); if(d.auth.token) Q('#tokenView').textContent=d.auth.token; const g=Q('#globalSearch'); if(g) g.addEventListener('input', renderAll); }
function enterApp(){ Q('#splash').style.display='none'; buildSideAndMain(); }
</script>
</body>
</html>
