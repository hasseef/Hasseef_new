<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>حصيف — نموذج متكامل (ملف واحد)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: { DEFAULT: '#5AA044' },
            accent:  { DEFAULT: '#F8BE43' },
            ink:     { DEFAULT: '#0f172a' },
            stone:   { DEFAULT: '#f8fafc' }
          },
          boxShadow: { soft: '0 10px 20px rgba(2,6,23,.08)' },
          borderRadius: { xl2: '1rem' }
        }
      }
    }
  </script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    .glass { backdrop-filter: blur(8px); background: rgba(255,255,255,.7); }
    .scroll-slim::-webkit-scrollbar{width:8px;height:8px}
    .scroll-slim::-webkit-scrollbar-thumb{background:#e5e7eb;border-radius:8px}
    .rtl-input { direction: rtl; }
    table { border-collapse: separate; border-spacing: 0 8px; }
    thead th { font-weight:600; color:#0f172a; }
    tbody tr { background:#fff; box-shadow: 0 1px 2px rgba(2,6,23,.05); }
    tbody td { border-top: 1px solid #f1f5f9; border-bottom:1px solid #f1f5f9; }
    tbody td:first-child { border-right:1px solid #f1f5f9; border-radius: .5rem 0 0 .5rem; }
    tbody td:last-child { border-left:1px solid #f1f5f9; border-radius: 0 .5rem .5rem 0; }
    #leafletMap { height: 340px; }
    .logo-vision { height: 34px; } .logo-talbiya { height: 40px; } .logo-hasseef { height: 46px; }
    @media (max-width: 640px){ .logo-vision { height: 28px; } .logo-talbiya { height: 32px; } .logo-hasseef { height: 38px; } }
    .topbar-gradient { background: linear-gradient(90deg, #5AA044 0%, #F8BE43 100%); }
    .gradient-primary { background: linear-gradient(90deg, #5AA044, #F8BE43); color:#fff; }
    .gradient-primary:hover { filter: brightness(0.96); }
  </style>
</head>
<body class="bg-stone text-ink antialiased">
  <header class="sticky top-0 z-40 shadow-soft topbar-gradient">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex items-center gap-3">
      <div class="flex items-center gap-2 order-1 md:order-1">
        <img id="logoHasseef" alt="حصيف" class="logo-hasseef select-none" loading="eager" decoding="async"
             src="data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='60'%3E%3Crect width='100%25' height='100%25' fill='white'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='20' fill='%235AA044' font-family='sans-serif'%3EHasseef%3C/text%3E%3C/svg%3E" />
        <div class="leading-5 hidden sm:block text-white">
          <div class="font-semibold" data-i18n="brand">حصيف</div>
          <div class="text-xs text-white/90" data-i18n="brandSub">منصة تكامل تنموي مرتبطة برؤية 2030</div>
        </div>
      </div>
      <div class="flex-1 order-2"></div>
      <div class="order-3 flex items-center gap-3 w-full max-w-xl">
        <div class="flex items-center gap-2">
          <button id="btnAR" class="px-2 py-1 rounded-lg gradient-primary text-xs">عربي</button>
          <button id="btnEN" class="px-2 py-1 rounded-lg bg-slate-900 text-white text-xs">English</button>
        </div>
        <div class="relative flex-1">
          <input id="globalSearch" type="search" class="rtl-input w-full rounded-xl2 border border-white/20 bg-white/70 focus:outline-none focus:ring-2 focus:ring-white/40 px-4 py-2 text-sm"
            placeholder="ابحث عن: مشروع، فعالية، وظيفة، منحة، مرفق..." />
          <button class="absolute left-2 top-1/2 -translate-y-1/2 text-white" aria-label="Search">
            <i data-lucide="search" class="w-5 h-5"></i>
          </button>
        </div>
        <button id="btnNotifications" class="relative p-2 rounded-xl2 hover:bg-white/20 transition text-white" aria-label="Notifications">
          <i data-lucide="bell" class="w-5 h-5"></i>
          <span class="absolute -top-1 -right-1 bg-primary text-white text-[10px] leading-4 rounded-full px-1.5">3</span>
        </button>
      </div>
      <div class="order-4 flex items-center gap-3">
        <img id="logoVision" alt="Vision 2030" class="logo-vision select-none" loading="eager" decoding="async"
             src="data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='140' height='44'%3E%3Crect width='100%25' height='100%25' fill='white'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='16' fill='%230f172a' font-family='sans-serif'%3EVision 2030%3C/text%3E%3C/svg%3E" />
        <img id="logoTalbiya" alt="مبادرة تلبية" class="logo-talbiya select-none" loading="eager" decoding="async"
             src="data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='140' height='50'%3E%3Crect width='100%25' height='100%25' fill='white'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='16' fill='%230f172a' font-family='sans-serif'%3ETalbiya%3C/text%3E%3C/svg%3E" />
      </div>
    </div>
  </header>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 grid grid-cols-12 gap-6">
    <aside class="col-span-12 md:col-span-3 lg:col-span-3">
      <div class="bg-white rounded-2xl shadow-soft p-4 space-y-4">
        <div>
          <div class="text-xs font-semibold text-slate-500 mb-2" data-i18n="generalSec">القسم العام</div>
          <nav class="space-y-1" id="navMain">
            <button data-route="dashboard" class="navlink w-full flex items-center justify-between px-3 py-2 rounded-lg hover:bg-slate-50">
              <span class="flex items-center gap-2"><i data-lucide="layout-dashboard" class="w-4 h-4"></i> <span data-i18n="home">الرئيسية</span></span>
              <span class="text-xs text-slate-400">Alt+1</span>
            </button>
            <button data-route="map" class="navlink w-full flex items-center justify-between px-3 py-2 rounded-lg hover:bg-slate-50">
              <span class="flex items-center gap-2"><i data-lucide="map" class="w-4 h-4"></i> <span data-i18n="regionsMap">خريطة المناطق</span></span>
            </button>
            <button data-route="stories" class="navlink w-full flex items-center justify-between px-3 py-2 rounded-lg hover:bg-slate-50">
              <span class="flex items-center gap-2"><i data-lucide="sparkles" class="w-4 h-4"></i> <span data-i18n="impactStories">قصص الأثر</span></span>
            </button>
          </nav>
        </div>

        <div class="pt-2">
          <div class="text-xs font-semibold text-slate-500 mb-2" data-i18n="accounts">الحسابات</div>
          <div class="grid grid-cols-2 gap-2" id="accountsGrid"></div>
        </div>

        <div class="pt-2">
          <div class="text-xs font-semibold text-slate-500 mb-2" data-i18n="modules">المكوّنات</div>
          <div class="grid grid-cols-2 sm:grid-cols-3 gap-2" id="modulesGrid"></div>
        </div>
      </div>

      <div class="mt-4 bg-white rounded-2xl shadow-soft p-4">
        <div class="text-xs font-semibold text-slate-500 mb-2" data-i18n="quickActions">إجراءات سريعة</div>
        <div class="grid grid-cols-2 gap-2">
          <button id="btnNewProject" class="px-3 py-2 rounded-lg text-sm gradient-primary hover:opacity-95" data-i18n="addProject">+ مشروع</button>
          <button id="btnNewEvent" class="px-3 py-2 rounded-lg text-sm bg-slate-900 text-white hover:opacity-90" data-i18n="addEvent">+ فعالية</button>
        </div>
      </div>
    </aside>

    <main class="col-span-12 md:col-span-9 lg:col-span-9 space-y-6">
      <section id="dashboard" class="view">
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
          <div class="bg-white rounded-2xl p-4 shadow-soft"><div class="text-xs text-slate-500" data-i18n="kpiActiveProjects">المشاريع النشطة</div><div id="kpiProjects" class="text-2xl font-bold mt-1">—</div></div>
          <div class="bg-white rounded-2xl p-4 shadow-soft"><div class="text-xs text-slate-500" data-i18n="kpiFunds">قيمة التمويل (ر.س)</div><div id="kpiFunding" class="text-2xl font-bold mt-1">—</div></div>
          <div class="bg-white rounded-2xl p-4 shadow-soft"><div class="text-xs text-slate-500" data-i18n="kpiUpcomingEvents">الفعاليات القادمة</div><div id="kpiEvents" class="text-2xl font-bold mt-1">—</div></div>
          <div class="bg-white rounded-2xl p-4 shadow-soft"><div class="text-xs text-slate-500" data-i18n="kpiVolOpps">فرص التطوع</div><div id="kpiVol" class="text-2xl font-bold mt-1">—</div></div>
        </div>

        <div class="bg-white rounded-2xl p-4 shadow-soft mt-4">
          <div class="flex flex-wrap items-center gap-2">
            <select id="filterRegion" class="rtl-input border rounded-lg px-3 py-2 text-sm">
              <option value="" data-i18n="allRegions">كل المناطق</option>
              <option>حائل</option><option>الرياض</option><option>مكة المكرمة</option>
            </select>
            <select id="filterSector" class="rtl-input border rounded-lg px-3 py-2 text-sm">
              <option value="" data-i18n="allSectors">كل القطاعات</option>
              <option>حكومي</option><option>خاص</option><option>غير ربحي</option><option>جامعات</option>
            </select>
            <select id="filterProgram" class="rtl-input border rounded-lg px-3 py-2 text-sm">
              <option value="" data-i18n="visionPrograms">برامج الرؤية</option>
              <option>التحول الوطني</option><option>جودة الحياة</option><option>تنمية القدرات البشرية</option>
              <option>تطوير القطاع المالي</option><option>الصناعة الوطنية والخدمات اللوجستية</option><option>الإسكان</option>
            </select>
            <div class="flex-1"></div>
            <button id="btnExportPDF" class="text-sm px-3 py-2 rounded-lg bg-slate-900 text-white" data-i18n="exportPDF">تصدير PDF</button>
            <button id="btnExportXLSX" class="text-sm px-3 py-2 rounded-lg bg-slate-100" data-i18n="exportXLSX">تصدير Excel</button>
            <button id="btnResetFilters" class="text-sm px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200" data-i18n="reset">إعادة الضبط</button>
          </div>
        </div>

        <div class="bg-white rounded-2xl p-4 shadow-soft mt-4">
          <div class="flex items-center justify-between mb-2">
            <div class="font-semibold" data-i18n="projects">المشاريع</div>
            <div class="text-xs text-slate-500" data-i18n="demoNote">نموذج عرض — للتجربة فقط</div>
          </div>
          <div class="overflow-auto scroll-slim">
            <table class="w-full text-sm" id="projectsTable">
              <thead>
                <tr class="text-right text-slate-500">
                  <th class="px-3 py-2" data-i18n="thProject">المشروع</th>
                  <th class="px-3 py-2" data-i18n="thSector">القطاع</th>
                  <th class="px-3 py-2" data-i18n="thRegion">المنطقة</th>
                  <th class="px-3 py-2" data-i18n="thProgram">البرنامج</th>
                  <th class="px-3 py-2" data-i18n="thFund">التمويل (ر.س)</th>
                  <th class="px-3 py-2" data-i18n="thStatus">الحالة</th>
                  <th class="px-3 py-2"></th>
                </tr>
              </thead>
              <tbody id="projectsTbody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="map" class="view hidden">
        <div class="bg-white rounded-2xl p-6 shadow-soft">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold" data-i18n="regionsMap">خريطة المناطق</h2>
            <div class="text-xs text-slate-500">© <a href="https://www.openstreetmap.org/copyright"
              target="_blank" class="underline">OpenStreetMap</a>, © Leaflet</div>
          </div>
          <div class="mt-4" id="leafletMap" class="rounded-xl2"></div>
          <div class="mt-3 text-xs text-slate-500" data-i18n="mapNote">الخريطة تجريبية وتعرض مؤشرات عدد المشاريع لكل منطقة.</div>
        </div>
      </section>

      <section id="stories" class="view hidden">
        <div class="bg-white rounded-2xl p-6 shadow-soft">
          <h2 class="text-lg font-semibold mb-3" data-i18n="impactStories">قصص أثر مختارة</h2>
          <div id="storiesWrap" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </div>
      </section>

      <!-- Per-account routes -->
      <section id="account-emirate" class="view hidden"></section>
      <section id="account-gov" class="view hidden"></section>
      <section id="account-private" class="view hidden"></section>
      <section id="account-nonprofit" class="view hidden"></section>
      <section id="account-uni" class="view hidden"></section>
      <section id="account-funder" class="view hidden"></section>
      <section id="account-people" class="view hidden"></section>
      <section id="account-speakers" class="view hidden"></section>
      <section id="account-admin" class="view hidden"></section>
    </main>
  </div>

  <!-- Drawers -->
  <div id="drawerProject" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/30" data-close-drawer></div>
    <div class="absolute left-0 top-0 bottom-0 w-full max-w-xl bg-white shadow-2xl p-6 overflow-y-auto">
      <div class="flex items-center justify-between sticky top-0 bg-white pb-3">
        <h3 class="text-lg font-semibold" data-i18n="newProject">مشروع جديد</h3>
        <button class="p-2 hover:bg-slate-100 rounded-lg" data-close-drawer><i data-lucide="x" class="w-5 h-5"></i></button>
      </div>
      <form id="formProject" class="space-y-4 mt-3">
        <div><label class="text-sm" data-i18n="fldName">اسم المشروع</label><input required class="rtl-input w-full mt-1 border rounded-lg px-3 py-2" name="name" /></div>
        <div class="grid grid-cols-2 gap-3">
          <div><label class="text-sm" data-i18n="fldSector">القطاع</label><select class="rtl-input w-full mt-1 border rounded-lg px-3 py-2" name="sector"><option>حكومي</option><option>خاص</option><option>غير ربحي</option><option>جامعات</option></select></div>
          <div><label class="text-sm" data-i18n="fldRegion">المنطقة</label><select class="rtl-input w-full mt-1 border rounded-lg px-3 py-2" name="region"><option>حائل</option><option>الرياض</option><option>مكة المكرمة</option></select></div>
        </div>
        <div><label class="text-sm" data-i18n="fldProgram">برنامج الرؤية (6/27/96)</label><select class="rtl-input w-full mt-1 border rounded-lg px-3 py-2" name="program"><option>جودة الحياة</option><option>التحول الوطني</option><option>تنمية القدرات البشرية</option><option>تطوير القطاع المالي</option><option>الصناعة الوطنية والخدمات اللوجستية</option><option>الإسكان</option></select></div>
        <div class="grid grid-cols-2 gap-3">
          <div><label class="text-sm" data-i18n="fldFund">التمويل المطلوب (ر.س)</label><input type="number" min="0" step="1000" class="rtl-input w-full mt-1 border rounded-lg px-3 py-2" name="fund" /></div>
          <div><label class="text-sm" data-i18n="fldStatus">الحالة</label><select class="rtl-input w-full mt-1 border rounded-lg px-3 py-2" name="status"><option>مسودة</option><option>قيد المراجعة</option><option>نشط</option></select></div>
        </div>
        <div><label class="text-sm" data-i18n="fldDesc">وصف موجز</label><textarea rows="3" class="rtl-input w-full mt-1 border rounded-lg px-3 py-2" name="desc"></textarea></div>
        <div class="pt-2 flex items-center gap-2"><button class="px-4 py-2 rounded-lg gradient-primary" data-i18n="save">حفظ</button><button class="px-4 py-2 rounded-lg bg-slate-100" type="button" data-close-drawer data-i18n="cancel">إلغاء</button></div>
      </form>
    </div>
  </div>

  <div id="drawerEvent" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/30" data-close-drawer></div>
    <div class="absolute left-0 top-0 bottom-0 w-full max-w-xl bg-white shadow-2xl p-6 overflow-y-auto">
      <div class="flex items-center justify-between sticky top-0 bg-white pb-3">
        <h3 class="text-lg font-semibold" data-i18n="newEvent">فعالية جديدة</h3>
        <button class="p-2 hover:bg-slate-100 rounded-lg" data-close-drawer><i data-lucide="x" class="w-5 h-5"></i></button>
      </div>
      <form id="formEvent" class="space-y-4 mt-3">
        <div><label class="text-sm" data-i18n="evtTitle">عنوان الفعالية</label><input required class="rtl-input w-full mt-1 border rounded-lg px-3 py-2" name="title" /></div>
        <div class="grid grid-cols-2 gap-3"><div><label class="text-sm" data-i18n="evtDate">التاريخ</label><input type="date" class="rtl-input w-full mt-1 border rounded-lg px-3 py-2" name="date" /></div><div><label class="text-sm" data-i18n="evtVenue">الموقع/المرفق</label><input class="rtl-input w-full mt-1 border rounded-lg px-3 py-2" name="venue" placeholder="قاعة، مسرح..." /></div></div>
        <div><label class="text-sm" data-i18n="evtDesc">الوصف</label><textarea rows="3" class="rtl-input w-full mt-1 border rounded-lg px-3 py-2" name="desc"></textarea></div>
        <div class="pt-2 flex items-center gap-2"><button class="px-4 py-2 rounded-lg bg-slate-900 text-white" data-i18n="save">حفظ</button><button class="px-4 py-2 rounded-lg bg-slate-100" type="button" data-close-drawer data-i18n="cancel">إلغاء</button></div>
      </form>
    </div>
  </div>

  <div id="toast" class="fixed bottom-6 right-6 px-4 py-3 rounded-xl2 bg-emerald-600 text-white text-sm shadow-soft hidden">تم الحفظ</div>

  <script>
    const i18n = {
      ar:{brand:'حصيف',brandSub:'منصة تكامل تنموي مرتبطة برؤية 2030',myAccount:'حسابي',generalSec:'القسم العام',home:'الرئيسية',regionsMap:'خريطة المناطق',impactStories:'قصص الأثر',accounts:'الحسابات',modules:'المكوّنات',quickActions:'إجراءات سريعة',addProject:'+ مشروع',addEvent:'+ فعالية',kpiActiveProjects:'المشاريع النشطة',kpiFunds:'قيمة التمويل (ر.س)',kpiUpcomingEvents:'الفعاليات القادمة',kpiVolOpps:'فرص التطوع',allRegions:'كل المناطق',allSectors:'كل القطاعات',visionPrograms:'برامج الرؤية',exportPDF:'تصدير PDF',exportXLSX:'تصدير Excel',reset:'إعادة الضبط',projects:'المشاريع',demoNote:'نموذج عرض — للتجربة فقط',thProject:'المشروع',thSector:'القطاع',thRegion:'المنطقة',thProgram:'البرنامج',thFund:'التمويل (ر.س)',thStatus:'الحالة',newProject:'مشروع جديد',fldName:'اسم المشروع',fldSector:'القطاع',fldRegion:'المنطقة',fldProgram:'برنامج الرؤية (6/27/96)',fldFund:'التمويل المطلوب (ر.س)',fldStatus:'الحالة',fldDesc:'وصف موجز',newEvent:'فعالية جديدة',evtTitle:'عنوان الفعالية',evtDate:'التاريخ',evtVenue:'الموقع/المرفق',evtDesc:'الوصف',save:'حفظ',cancel:'إلغاء',mapNote:'الخريطة تجريبية وتعرض مؤشرات عدد المشاريع لكل منطقة.',toastSaved:'تم الحفظ'},
      en:{brand:'Hasif',brandSub:'A national development-integration platform aligned with Vision 2030',myAccount:'My Account',generalSec:'General',home:'Home',regionsMap:'Regions Map',impactStories:'Impact Stories',accounts:'Accounts',modules:'Modules',quickActions:'Quick Actions',addProject:'+ Project',addEvent:'+ Event',kpiActiveProjects:'Active Projects',kpiFunds:'Funding (SAR)',kpiUpcomingEvents:'Upcoming Events',kpiVolOpps:'Volunteer Opportunities',allRegions:'All Regions',allSectors:'All Sectors',visionPrograms:'Vision Programs',exportPDF:'Export PDF',exportXLSX:'Export Excel',reset:'Reset',projects:'Projects',demoNote:'Demo — for testing only',thProject:'Project',thSector:'Sector',thRegion:'Region',thProgram:'Program',thFund:'Funding (SAR)',thStatus:'Status',newProject:'New Project',fldName:'Project Name',fldSector:'Sector',fldRegion:'Region',fldProgram:'Vision Program (6/27/96)',fldFund:'Requested Funding (SAR)',fldStatus:'Status',fldDesc:'Brief Description',newEvent:'New Event',evtTitle:'Event Title',evtDate:'Date',evtVenue:'Venue/Facility',evtDesc:'Description',save:'Save',cancel:'Cancel',mapNote:'Experimental map showing project counts per region.',toastSaved:'Saved'}
    };
    let currentLang=(localStorage.getItem('lang')||'ar');
    const $=(q,c=document)=>c.querySelector(q), $$=(q,c=document)=>Array.from(c.querySelectorAll(q));
    function toast(m){const el=$('#toast');el.textContent=m;el.classList.remove('hidden');setTimeout(()=>el.classList.add('hidden'),1800)}

    const accounts=[
      {key:'emirate',name_ar:'إمارة المنطقة',name_en:'Regional Emirate',icon:'shield',color:'from-primary to-accent'},
      {key:'gov',name_ar:'جهة حكومية',name_en:'Government Entity',icon:'building-2',color:'from-primary to-accent'},
      {key:'private',name_ar:'قطاع خاص',name_en:'Private Sector',icon:'briefcase',color:'from-primary to-accent'},
      {key:'nonprofit',name_ar:'قطاع غير ربحي',name_en:'Nonprofit',icon:'heart',color:'from-primary to-accent'},
      {key:'uni',name_ar:'الجامعات',name_en:'Universities',icon:'graduation-cap',color:'from-primary to-accent'},
      {key:'funder',name_ar:'جهات مانحة',name_en:'Funders',icon:'wallet',color:'from-primary to-accent'},
      {key:'people',name_ar:'الأفراد',name_en:'Individuals',icon:'users',color:'from-primary to-accent'},
      {key:'speakers',name_ar:'مدربون/متحدثون',name_en:'Trainers/Speakers',icon:'mic',color:'from-primary to-accent'},
      {key:'admin',name_ar:'حوكمة المنصة',name_en:'Platform Governance',icon:'settings',color:'from-primary to-accent'},
    ];
    const modules=[
      {key:'projects',label_ar:'مشاريع',label_en:'Projects',icon:'folder-kanban'},
      {key:'challenges',label_ar:'تحديات',label_en:'Challenges',icon:'puzzle'},
      {key:'events',label_ar:'فعاليات',label_en:'Events',icon:'calendar'},
      {key:'facilities',label_ar:'مرافق',label_en:'Facilities',icon:'building'},
      {key:'jobs',label_ar:'وظائف',label_en:'Jobs',icon:'badge-check'},
      {key:'training',label_ar:'تدريب',label_en:'Training',icon:'book-open'},
      {key:'volunteer',label_ar:'تطوع',label_en:'Volunteer',icon:'hand-heart'},
      {key:'advisory',label_ar:'استشارات',label_en:'Advisory',icon:'life-buoy'},
      {key:'invest',label_ar:'استثمار',label_en:'Investment',icon:'trend-up'},
      {key:'donate',label_ar:'تبرعات',label_en:'Donations',icon:'donut'},
      {key:'funding',label_ar:'تمويل',label_en:'Funding',icon:'credit-card'},
      {key:'reports',label_ar:'تقارير',label_en:'Reports',icon:'bar-chart-3'},
    ];

    let projects=[
      {id:1,name:'مختبر ابتكار اجتماعي',sector:'جامعات',region:'حائل',program:'جودة الحياة',fund:250000,status:'نشط'},
      {id:2,name:'تمكين الأسر المنتجة',sector:'غير ربحي',region:'الرياض',program:'التحول الوطني',fund:180000,status:'قيد المراجعة'},
      {id:3,name:'مركز قيادة تطوعي',sector:'حكومي',region:'مكة المكرمة',program:'تنمية القدرات البشرية',fund:320000,status:'نشط'},
      {id:4,name:'منصة تعاون بحثي',sector:'جامعات',region:'حائل',program:'تطوير القطاع المالي',fund:120000,status:'مسودة'},
      {id:5,name:'برنامج توظيف حديثي التخرج',sector:'خاص',region:'الرياض',program:'الصناعة الوطنية والخدمات اللوجستية',fund:210000,status:'نشط'},
    ];
    let events=[
      {id:1,title:'منتدى الإعلام التنموي',date:'2025-11-15',venue:'قاعة الغرفة التجارية',desc:'حضور قادة القطاعات'},
      {id:2,title:'لقاء الجامعات والجهات',date:'2025-12-02',venue:'جامعة حائل',desc:'ربط البحث بالتنفيذ'},
    ];

    function renderAccounts(){const w=$('#accountsGrid');w.innerHTML='';accounts.forEach(a=>{const b=document.createElement('button');b.className='flex items-center gap-2 px-3 py-2 rounded-lg border hover:shadow-soft transition text-sm';b.innerHTML=`<i data-lucide="${a.icon}" class="w-4 h-4"></i><span>${currentLang==='ar'?a.name_ar:a.name_en}</span>`;b.onclick=()=>{switchView('account-'+a.key);buildAccountPage(a.key)};w.appendChild(b);});}
    function renderModules(){const w=$('#modulesGrid');w.innerHTML='';modules.forEach(m=>{const b=document.createElement('button');b.className='flex items-center gap-2 px-3 py-2 rounded-lg border hover:bg-slate-50 transition text-sm';b.innerHTML=`<i data-lucide="${m.icon}" class="w-4 h-4"></i><span>${currentLang==='ar'?m.label_ar:m.label_en}</span>`;b.onclick=()=>{if(m.key==='projects')switchView('dashboard');else if(m.key==='events')switchView('map');else toast((currentLang==='ar'?'المكوّن: ':'Module: ')+(currentLang==='ar'?m.label_ar:m.label_en));};w.appendChild(b);});}
    function renderKPIs(){ $('#kpiProjects').textContent=projects.length; const funding=projects.reduce((s,p)=>s+(+p.fund||0),0); $('#kpiFunding').textContent=funding.toLocaleString(currentLang==='ar'?'ar-EG':'en-US'); $('#kpiEvents').textContent=events.length; $('#kpiVol').textContent=7; }
    function renderProjectsTable(){const tb=$('#projectsTbody');const r=$('#filterRegion').value,s=$('#filterSector').value,p=$('#filterProgram').value,q=$('#globalSearch').value.trim();let L=projects.slice(); if(r)L=L.filter(x=>x.region===r); if(s)L=L.filter(x=>x.sector===s); if(p)L=L.filter(x=>x.program===p); if(q){const t=q.split(/\s+/); L=L.filter(x=>t.every(v=>(x.name+x.sector+x.region+x.program+x.status).includes(v)));} tb.innerHTML=''; L.forEach(x=>{const tr=document.createElement('tr'); tr.innerHTML=`<td class='px-3 py-3 font-medium'>${x.name}</td><td class='px-3 py-3 text-slate-600'>${x.sector}</td><td class='px-3 py-3 text-slate-600'>${x.region}</td><td class='px-3 py-3 text-slate-600'>${x.program}</td><td class='px-3 py-3 text-slate-600'>${(+x.fund||0).toLocaleString(currentLang==='ar'?'ar-EG':'en-US')}</td><td class='px-3 py-3'><span class='px-2 py-1 rounded-full text-xs ${x.status==='نشط'?'bg-emerald-100 text-emerald-700':x.status==='قيد المراجعة'?'bg-amber-100 text-amber-700':'bg-slate-100 text-slate-700'}'>${x.status}</span></td><td class='px-3 py-3'><div class='flex items-center gap-2'><button class='p-2 rounded-lg hover:bg-slate-100' aria-label='Edit'><i data-lucide="pen" class="w-4 h-4"></i></button><button class='p-2 rounded-lg hover:bg-slate-100' aria-label='Delete'><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></td>`; tb.appendChild(tr);}); lucide.createIcons();}
    function renderStories(){const w=$('#storiesWrap');w.innerHTML='';[{title_ar:'تمكين 120 مستفيدًا عبر برنامج تدريب متكامل',kpi:'+86% توظيف',region_ar:'حائل',title_en:'Empowering 120 beneficiaries via integrated training',region_en:'Hail'},{title_ar:'تطوير مرافق جامعية لاحتضان مبادرات نوعية',kpi:'3 حاضنات',region_ar:'الرياض',title_en:'Upgrading university facilities for flagship initiatives',region_en:'Riyadh'},{title_ar:'تحسين جودة الحياة عبر فعاليات مجتمعية',kpi:'5 فعاليات',region_ar:'مكة',title_en:'Improving quality of life via community events',region_en:'Makkah'},{title_ar:'زيادة الشفافية في المنح والرعايات',kpi:'+1.2م ر.س',region_ar:'الرياض',title_en:'Greater transparency in grants and sponsorships',region_en:'Riyadh'}].forEach(s=>{const c=document.createElement('div');c.className='p-4 rounded-2xl border bg-white';const t=currentLang==='ar'?s.title_ar:s.title_en;const r=currentLang==='ar'?s.region_ar:s.region_en;c.innerHTML=`<div class='text-sm text-slate-500'>${r}</div><div class='font-semibold mt-1'>${t}</div><div class='mt-3 text-primary text-sm'>${s.kpi}</div>`;w.appendChild(c);});}
    let mapInstance=null; function initMap(){ if(mapInstance){mapInstance.invalidateSize();return;} mapInstance=L.map('leafletMap').setView([23.8859,45.0792],5); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18,attribution:'&copy; OpenStreetMap contributors'}).addTo(mapInstance); [{name_ar:'حائل',name_en:'Hail',lat:27.5219,lng:41.6907,count:12},{name_ar:'الرياض',name_en:'Riyadh',lat:24.7136,lng:46.6753,count:18},{name_ar:'مكة المكرمة',name_en:'Makkah',lat:21.3891,lng:39.8579,count:9}].forEach(r=>{const label=currentLang==='ar'?r.name_ar:r.name_en; L.marker([r.lat,r.lng]).addTo(mapInstance).bindPopup(`<div class="text-sm"><b>${label}</b><br>${currentLang==='ar'?'مشاريع:':'Projects:'} ${r.count}</div>`);}); }
    function buildAccountPage(key){const meta=accounts.find(a=>a.key===key);const id='account-'+key;const sec=document.getElementById(id);if(!sec)return;const title=currentLang==='ar'?meta.name_ar:meta.name_en;sec.innerHTML=`<div class="bg-white rounded-2xl p-5 shadow-soft"><div class="flex items-center justify-between"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl bg-gradient-to-r ${meta.color} flex items-center justify-center text-white"><i data-lucide="${meta.icon}" class="w-5 h-5"></i></div><div><div class="text-xs text-slate-500">${currentLang==='ar'?'الملف':'Profile'}</div><h2 class="text-lg font-semibold">${title}</h2></div></div><div class="flex items-center gap-2"><button class="px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-sm">${currentLang==='ar'?'تصدير':'Export'}</button><button class="px-3 py-2 rounded-lg gradient-primary text-sm">${currentLang==='ar'?'إنشاء جديد':'New'}</button></div></div><div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mt-4"><div class="bg-slate-50 rounded-xl p-4"><div class="text-xs text-slate-500">${currentLang==='ar'?'مشاريع':'Projects'}</div><div class="text-2xl font-bold">12</div></div><div class="bg-slate-50 rounded-xl p-4"><div class="text-xs text-slate-500">${currentLang==='ar'?'تمويل (ر.س)':'Funding (SAR)'}</div><div class="text-2xl font-bold">1,280,000</div></div><div class="bg-slate-50 rounded-xl p-4"><div class="text-xs text-slate-500">${currentLang==='ar'?'فعاليات':'Events'}</div><div class="text-2xl font-bold">3</div></div><div class="bg-slate-50 rounded-xl p-4"><div class="text-xs text-slate-500">${currentLang==='ar'?'فرص':'Opportunities'}</div><div class="text-2xl font-bold">7</div></div></div><div class="mt-5"><div class="flex items-center gap-2 text-sm"><button class="tab-btn px-3 py-2 rounded-lg bg-slate-900 text-white" data-tab="tab-${id}-projects">${currentLang==='ar'?'المشاريع':'Projects'}</button><button class="tab-btn px-3 py-2 rounded-lg bg-slate-100" data-tab="tab-${id}-events">${currentLang==='ar'?'الفعاليات':'Events'}</button><button class="tab-btn px-3 py-2 rounded-lg bg-slate-100" data-tab="tab-${id}-jobs">${currentLang==='ar'?'الوظائف/التطوع':'Jobs/Volunteer'}</button><button class="tab-btn px-3 py-2 rounded-lg bg-slate-100" data-tab="tab-${id}-resources">${currentLang==='ar'?'المرافق/المنح':'Facilities/Grants'}</button></div><div id="tab-${id}-projects" class="tab mt-3"><div class="overflow-auto scroll-slim"><table class="w-full text-sm"><thead><tr class="text-right text-slate-500"><th class="px-3 py-2">${currentLang==='ar'?'المشروع':'Project'}</th><th class="px-3 py-2">${currentLang==='ar'?'القطاع':'Sector'}</th><th class="px-3 py-2">${currentLang==='ar'?'الحالة':'Status'}</th><th class="px-3 py-2">${currentLang==='ar'?'التمويل':'Funding'}</th><th class="px-3 py-2"></th></tr></thead><tbody><tr><td class="px-3 py-3 font-medium">برنامج تمكين رقمي</td><td class="px-3 py-3 text-slate-600">جامعات</td><td class="px-3 py-3"><span class="px-2 py-1 rounded-full text-xs bg-emerald-100 text-emerald-700">${currentLang==='ar'?'نشط':'Active'}</span></td><td class="px-3 py-3 text-slate-600">320,000</td><td class="px-3 py-3"><button class="p-2 rounded-lg hover:bg-slate-100"><i data-lucide="arrow-right" class="w-4 h-4"></i></button></td></tr><tr><td class="px-3 py-3 font-medium">مختبر ابتكار اجتماعي</td><td class="px-3 py-3 text-slate-600">غير ربحي</td><td class="px-3 py-3"><span class="px-2 py-1 rounded-full text-xs bg-amber-100 text-amber-700">${currentLang==='ar'?'قيد المراجعة':'Review'}</span></td><td class="px-3 py-3 text-slate-600">180,000</td><td class="px-3 py-3"><button class="p-2 rounded-lg hover:bg-slate-100"><i data-lucide="arrow-right" class="w-4 h-4"></i></button></td></tr></tbody></table></div></div><div id="tab-${id}-events" class="tab mt-3 hidden"><div class="grid grid-cols-1 md:grid-cols-2 gap-3"><div class="p-4 rounded-2xl border bg-white"><div class="text-sm text-slate-500">2025-12-02 • ${currentLang==='ar'?'جامعة حائل':'University of Hail'}</div><div class="font-semibold mt-1">${currentLang==='ar'?'ملتقى التحول التنموي':'Development Transformation Forum'}</div></div><div class="p-4 rounded-2xl border bg-white"><div class="text-sm text-slate-500">2025-11-15 • ${currentLang==='ar'?'الغرفة التجارية':'Chamber of Commerce'}</div><div class="font-semibold mt-1">${currentLang==='ar'?'منتدى الإعلام التنموي':'Development Media Forum'}</div></div></div></div><div id="tab-${id}-jobs" class="tab mt-3 hidden"><div class="grid grid-cols-1 md:grid-cols-2 gap-3"><div class="p-4 rounded-2xl border bg-white"><div class="font-semibold">${currentLang==='ar'?'منسق برامج':'Programs Coordinator'}</div><div class="text-sm text-slate-500">${currentLang==='ar'?'دوام كامل • الرياض':'Full-time • Riyadh'}</div></div><div class="p-4 rounded-2xl border bg-white"><div class="font-semibold">${currentLang==='ar'?'متطوع فعاليات':'Events Volunteer'}</div><div class="text-sm text-slate-500">${currentLang==='ar'?'جزئي • حائل':'Part-time • Hail'}</div></div></div></div><div id="tab-${id}-resources" class="tab mt-3 hidden"><div class="grid grid-cols-1 md:grid-cols-2 gap-3"><div class="p-4 rounded-2xl border bg-white"><div class="font-semibold">${currentLang==='ar'?'منحة صغيرة — جودة الحياة':'Micro Grant — Quality of Life'}</div><div class="text-sm text-slate-500">${currentLang==='ar'?'حتى 100 ألف ر.س':'Up to 100k SAR'}</div></div><div class="p-4 rounded-2xl border bg-white"><div class="font-semibold">${currentLang==='ar'?'مرفق تدريب مشترك':'Shared Training Facility'}</div><div class="text-sm text-slate-500">${currentLang==='ar'?'جامعة حائل':'University of Hail'}</div></div></div></div></div></div>`; sec.querySelectorAll('.tab-btn').forEach(btn=>{btn.onclick=()=>{const target=btn.getAttribute('data-tab');sec.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('bg-slate-900','text-white'));btn.classList.add('bg-slate-900','text-white');sec.querySelectorAll('.tab').forEach(t=>t.classList.add('hidden'));sec.querySelector('#'+target)?.classList.remove('hidden');};}); lucide.createIcons();}
    function openDrawer(id){ $('#'+id).classList.remove('hidden'); } function closeDrawer(id){ $('#'+id).classList.add('hidden'); }
    document.getElementById('btnNewProject').onclick=()=>openDrawer('drawerProject'); document.getElementById('btnNewEvent').onclick=()=>openDrawer('drawerEvent');
    $$('#drawerProject [data-close-drawer]').forEach(b=>b.onclick=()=>closeDrawer('drawerProject'));
    $$('#drawerEvent [data-close-drawer]').forEach(b=>b.onclick=()=>closeDrawer('drawerEvent'));
    document.getElementById('formProject').addEventListener('submit',(e)=>{e.preventDefault();const fd=new FormData(e.target);const item={id:Math.max(0,...projects.map(p=>p.id))+1,name:fd.get('name'),sector:fd.get('sector'),region:fd.get('region'),program:fd.get('program'),fund:Number(fd.get('fund')||0),status:fd.get('status')};projects.unshift(item);closeDrawer('drawerProject');renderKPIs();renderProjectsTable();e.target.reset();toast(i18n[currentLang].toastSaved);});
    document.getElementById('formEvent').addEventListener('submit',(e)=>{e.preventDefault();const fd=new FormData(e.target);events.unshift({id:Math.max(0,...events.map(x=>x.id))+1,title:fd.get('title'),date:fd.get('date'),venue:fd.get('venue'),desc:fd.get('desc')});closeDrawer('drawerEvent');renderKPIs();e.target.reset();toast(i18n[currentLang].toastSaved);});
    $('#filterRegion').onchange=renderProjectsTable; $('#filterSector').onchange=renderProjectsTable; $('#filterProgram').onchange=renderProjectsTable;
    $('#btnResetFilters').onclick=()=>{$('#filterRegion').value='';$('#filterSector').value='';$('#filterProgram').value='';$('#globalSearch').value='';renderProjectsTable();};
    $('#globalSearch').addEventListener('input',renderProjectsTable);
    function switchView(id){ $$('.view').forEach(v=>v.classList.add('hidden')); $('#'+id)?.classList.remove('hidden'); $$('#navMain .navlink').forEach(b=>b.classList.remove('bg-slate-100')); $(`#navMain .navlink[data-route="${id}"]`)?.classList.add('bg-slate-100'); location.hash=id; if(id==='map'){ setTimeout(()=>{ initMap(); mapInstance && mapInstance.invalidateSize(); }, 60);} if(id.startsWith('account-')){ buildAccountPage(id.replace('account-','')); } }
    window.addEventListener('hashchange',()=>switchView(location.hash.replace('#','')||'dashboard'));
    window.addEventListener('keydown',(e)=>{if(e.altKey&&e.key==='1'){switchView('dashboard')}});
    document.getElementById('btnExportPDF').onclick=()=>{const {jsPDF}=window.jspdf;const doc=new jsPDF();const title=(currentLang==='ar'?'قائمة المشاريع':'Projects List');doc.setFontSize(14);doc.text(title,14,16);const head=[[i18n[currentLang].thProject,i18n[currentLang].thSector,i18n[currentLang].thRegion,i18n[currentLang].thProgram,i18n[currentLang].thFund,i18n[currentLang].thStatus]];const body=Array.from(document.querySelectorAll('#projectsTbody tr')).map(tr=>Array.from(tr.querySelectorAll('td')).map(td=>td.innerText.trim()).slice(0,6));doc.autoTable({head,body,startY:22,styles:{fontSize:10}});doc.save('projects.pdf');};
    document.getElementById('btnExportXLSX').onclick=()=>{const data=[['ID','Project','Sector','Region','Program','Funding','Status']];projects.forEach(p=>data.push([p.id,p.name,p.sector,p.region,p.program,p.fund,p.status]));const ws=XLSX.utils.aoa_to_sheet(data);const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'Projects');XLSX.writeFile(wb,'projects.xlsx');};
    function applyI18n(lang){currentLang=lang;localStorage.setItem('lang',lang);document.documentElement.lang=lang;const rtl=(lang==='ar');document.documentElement.dir=rtl?'rtl':'ltr';document.querySelectorAll('input,textarea,select').forEach(el=>rtl?el.classList.add('rtl-input'):el.classList.remove('rtl-input'));document.querySelectorAll('[data-i18n]').forEach(el=>{const k=el.getAttribute('data-i18n');if(i18n[lang][k]) el.textContent=i18n[lang][k];});$('#globalSearch').placeholder=rtl?'ابحث عن: مشروع، فعالية، وظيفة، منحة، مرفق...':'Search: project, event, job, grant, facility...';document.querySelectorAll('thead tr').forEach(tr=>{rtl?tr.classList.replace('text-left','text-right'):tr.classList.replace('text-right','text-left')});lucide.createIcons();}
    document.getElementById('btnAR').onclick=()=>{applyI18n('ar');renderAccounts();renderModules();renderKPIs();renderProjectsTable();renderStories();if(location.hash.replace('#','')==='map'){mapInstance&&mapInstance.remove();mapInstance=null;setTimeout(initMap,50);}};
    document.getElementById('btnEN').onclick=()=>{applyI18n('en');renderAccounts();renderModules();renderKPIs();renderProjectsTable();renderStories();if(location.hash.replace('#','')==='map'){mapInstance&&mapInstance.remove();mapInstance=null;setTimeout(initMap,50);}};
    function init(){applyI18n(currentLang);renderAccounts();renderModules();renderKPIs();renderProjectsTable();renderStories();switchView(location.hash.replace('#','')||'dashboard');lucide.createIcons();}
    init();
  </script>
</body>
</html>